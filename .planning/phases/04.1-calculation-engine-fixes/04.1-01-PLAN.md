---
phase: 04.1-calculation-engine-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/calculations/statistics.ts
  - src/lib/calculations/statistics.test.ts
  - src/lib/calculations/evpi.ts
  - src/lib/calculations/evpi.test.ts
autonomous: true

must_haves:
  truths:
    - "standardNormalCDF returns NaN when given NaN input"
    - "calculateEVPI returns EVPI=0 when sigma_L=0 (degenerate prior)"
    - "Unit tests verify both edge case fixes"
  artifacts:
    - path: "src/lib/calculations/statistics.ts"
      provides: "NaN handling in standardNormalCDF"
      contains: "Number.isNaN"
    - path: "src/lib/calculations/evpi.ts"
      provides: "Degenerate sigma handling"
      contains: "Infinity"
    - path: "src/lib/calculations/statistics.test.ts"
      provides: "NaN input test"
      contains: "NaN"
    - path: "src/lib/calculations/evpi.test.ts"
      provides: "Degenerate sigma test"
      contains: "sigma_L: 0"
  key_links:
    - from: "src/lib/calculations/evpi.ts"
      to: "src/lib/calculations/statistics.ts"
      via: "standardNormalPDF and standardNormalCDF imports"
      pattern: "import.*standardNormal"
---

<objective>
Fix two edge case bugs in the calculation engine and add corresponding test coverage.

Purpose: Ensure EVPI calculations are mathematically correct for degenerate inputs (sigma=0) and that NaN propagates properly through CDF calculations rather than being silently converted to 1.

Output:
- Fixed `standardNormalCDF` that returns NaN for NaN input
- Fixed `calculateEVPI` that returns EVPI=0 for degenerate sigma
- Unit tests verifying both fixes
</objective>

<execution_context>
@/Users/ryan.lucht/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryan.lucht/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context with issue details and suggested patches
@.planning/phases/04.1-calculation-engine-fixes/04.1-CONTEXT.md

# Source files to modify
@src/lib/calculations/statistics.ts
@src/lib/calculations/evpi.ts

# Existing test files to extend
@src/lib/calculations/statistics.test.ts
@src/lib/calculations/evpi.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix standardNormalCDF NaN handling</name>
  <files>src/lib/calculations/statistics.ts, src/lib/calculations/statistics.test.ts</files>
  <action>
    1. In `statistics.ts`, add NaN check at the start of `standardNormalCDF`:
       ```typescript
       // Handle NaN input - must propagate as NaN, not be treated as finite
       if (Number.isNaN(z)) {
         return NaN;
       }
       ```
       Place this BEFORE the existing `!isFinite(z)` check.

    2. In `statistics.test.ts`, add a test in the `standardNormalCDF` describe block:
       ```typescript
       it('should return NaN for NaN input', () => {
         const result = standardNormalCDF(NaN);
         expect(result).toBeNaN();
       });
       ```
  </action>
  <verify>
    Run: `npm test -- --run src/lib/calculations/statistics.test.ts`
    All tests pass, including the new NaN test.
  </verify>
  <done>
    - `standardNormalCDF(NaN)` returns `NaN`
    - Test explicitly verifies this behavior
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix calculateEVPI degenerate sigma handling</name>
  <files>src/lib/calculations/evpi.ts, src/lib/calculations/evpi.test.ts</files>
  <action>
    1. In `evpi.ts`, replace the z-score calculation (around line 70):

       FROM:
       ```typescript
       const zScore = sigma_L > 0 ? (threshold_L - mu_L) / sigma_L : 0;
       ```

       TO:
       ```typescript
       // Handle degenerate prior (sigma = 0): z-score represents where threshold
       // is relative to the point mass at mu_L
       // - If threshold equals mu: z = 0 (boundary case)
       // - If threshold > mu: z = +Infinity (threshold above point mass)
       // - If threshold < mu: z = -Infinity (threshold below point mass)
       let zScore: number;
       if (sigma_L > 0) {
         zScore = (threshold_L - mu_L) / sigma_L;
       } else if (threshold_L === mu_L) {
         zScore = 0;
       } else {
         zScore = threshold_L > mu_L ? Infinity : -Infinity;
       }
       ```

    2. In `evpi.test.ts`, add a new describe block for degenerate sigma tests:
       ```typescript
       // ===========================================
       // 9. Degenerate sigma (sigma_L = 0) tests
       // ===========================================

       describe('degenerate sigma (sigma_L = 0)', () => {
         it('returns EVPI = 0 when sigma_L = 0 (no uncertainty)', () => {
           // When sigma = 0, the prior is a point mass - no uncertainty means
           // no value of information (we already know the true value)
           const result = calculateEVPI({
             baselineConversionRate: 0.05,
             annualVisitors: 1000000,
             valuePerConversion: 100,
             prior: { mu_L: 0.05, sigma_L: 0 }, // degenerate prior at 5%
             threshold_L: 0,
           });

           // EVPI should be exactly 0 - no uncertainty means no regret
           expect(result.evpiDollars).toBe(0);
         });

         it('returns EVPI = 0 when sigma_L = 0 and mu_L < threshold', () => {
           const result = calculateEVPI({
             baselineConversionRate: 0.05,
             annualVisitors: 1000000,
             valuePerConversion: 100,
             prior: { mu_L: 0, sigma_L: 0 }, // point mass at 0
             threshold_L: 0.05, // threshold above point mass
           });

           // Default is Don't Ship, and with certainty, no regret
           expect(result.defaultDecision).toBe('dont-ship');
           expect(result.evpiDollars).toBe(0);
         });

         it('returns EVPI = 0 when sigma_L = 0 and mu_L = threshold', () => {
           const result = calculateEVPI({
             baselineConversionRate: 0.05,
             annualVisitors: 1000000,
             valuePerConversion: 100,
             prior: { mu_L: 0.05, sigma_L: 0 }, // point mass at 5%
             threshold_L: 0.05, // threshold equals point mass
           });

           // Default is Ship (mu >= threshold), and with certainty, no regret
           expect(result.defaultDecision).toBe('ship');
           expect(result.evpiDollars).toBe(0);
         });
       });
       ```
  </action>
  <verify>
    Run: `npm test -- --run src/lib/calculations/evpi.test.ts`
    All tests pass, including the new degenerate sigma tests.
  </verify>
  <done>
    - `calculateEVPI` returns `evpiDollars = 0` for sigma_L = 0
    - Tests verify all three cases: mu > threshold, mu < threshold, mu = threshold
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and lint</name>
  <files>N/A</files>
  <action>
    Run the full test suite and lint to ensure no regressions:
    1. `npm run lint`
    2. `npm test`

    If any issues, fix them before marking complete.
  </action>
  <verify>
    - `npm run lint` exits with code 0
    - `npm test` shows all tests passing
  </verify>
  <done>
    - All linting passes
    - All tests pass (including existing EVPI and statistics tests)
    - No regressions introduced
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **NaN handling:**
   ```typescript
   import { standardNormalCDF } from './statistics';
   console.log(standardNormalCDF(NaN)); // Should print: NaN
   ```

2. **Degenerate sigma:**
   ```typescript
   import { calculateEVPI } from './evpi';
   const result = calculateEVPI({
     baselineConversionRate: 0.05,
     annualVisitors: 1000000,
     valuePerConversion: 100,
     prior: { mu_L: 0.05, sigma_L: 0 },
     threshold_L: 0,
   });
   console.log(result.evpiDollars); // Should print: 0
   ```

3. **No regressions:** All 50+ existing calculation tests still pass
</verification>

<success_criteria>
1. `standardNormalCDF(NaN)` returns `NaN` (not `1`)
2. `calculateEVPI` with `sigma_L: 0` returns `evpiDollars: 0` (not a non-zero value)
3. All new tests pass
4. All existing tests pass (no regressions)
5. Lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-calculation-engine-fixes/04.1-01-SUMMARY.md`
</output>
