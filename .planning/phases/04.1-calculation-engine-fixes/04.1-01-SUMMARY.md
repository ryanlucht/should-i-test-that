---
phase: 04.1-calculation-engine-fixes
plan: 01
subsystem: calculations
tags: [statistics, evpi, edge-cases, nan-handling]

# Dependency graph
requires:
  - phase: 03-calculation-engine
    provides: standardNormalCDF and calculateEVPI functions
provides:
  - NaN handling in standardNormalCDF
  - Degenerate sigma (sigma_L=0) handling in calculateEVPI
  - Edge case test coverage
affects: [advanced-mode, any-future-calculation-changes]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "NaN check before infinity check in distribution functions"
    - "Infinity z-scores for degenerate (zero-variance) priors"

key-files:
  created: []
  modified:
    - src/lib/calculations/statistics.ts
    - src/lib/calculations/statistics.test.ts
    - src/lib/calculations/evpi.ts
    - src/lib/calculations/evpi.test.ts

key-decisions:
  - "NaN check uses Number.isNaN() placed before isFinite() check"
  - "Degenerate sigma yields +/-Infinity z-score, causing phi(z)=0 and EVPI=0"

patterns-established:
  - "Edge case handling at function entry: NaN first, then Infinity, then finite"

# Metrics
duration: 4min
completed: 2026-01-30
---

# Phase 4.1 Plan 01: Calculation Engine Fixes Summary

**Fixed NaN propagation in standardNormalCDF and degenerate sigma handling in calculateEVPI with 4 new edge case tests**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-30T11:25:00Z
- **Completed:** 2026-01-30T11:29:00Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments

- Fixed `standardNormalCDF` to return NaN for NaN input (was incorrectly returning 1)
- Fixed `calculateEVPI` to return EVPI=0 for degenerate sigma (sigma_L=0)
- Added 4 new tests covering both edge cases
- All 153 tests passing with no regressions

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix standardNormalCDF NaN handling** - `8cd3857` (fix)
2. **Task 2: Fix calculateEVPI degenerate sigma handling** - `71052e6` (fix)
3. **Task 3: Run full test suite and lint** - No commit (verification only)

## Files Created/Modified

- `src/lib/calculations/statistics.ts` - Added NaN check before infinity check
- `src/lib/calculations/statistics.test.ts` - Added NaN input test
- `src/lib/calculations/evpi.ts` - Replaced z-score calculation to use +/-Infinity for sigma=0
- `src/lib/calculations/evpi.test.ts` - Added 3 degenerate sigma tests

## Decisions Made

1. **NaN check placement:** `Number.isNaN(z)` placed BEFORE `!isFinite(z)` check because `isFinite(NaN)` returns false, but `NaN < 0` also returns false, causing NaN to be treated as +Infinity and return 1.

2. **Infinity z-score for degenerate sigma:** When sigma=0, the prior is a point mass. Using +/-Infinity for z-score correctly causes:
   - `phi(z) = 0` (density at infinity is zero)
   - `Phi(+Infinity) = 1`, `Phi(-Infinity) = 0`
   - Both EVPI formulas evaluate to 0 (no uncertainty = no value of information)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Calculation engine edge cases fixed
- All 153 tests passing
- Ready for Phase 5 (Advanced Mode)

---
*Phase: 04.1-calculation-engine-fixes*
*Completed: 2026-01-30*
