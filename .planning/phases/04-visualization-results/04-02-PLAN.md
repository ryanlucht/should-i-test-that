---
phase: 04-visualization-results
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/charts/PriorDistributionChart.tsx
  - src/components/charts/ChartTooltip.tsx
  - src/components/forms/UncertaintyPriorForm.tsx
  - src/lib/formatting.ts
autonomous: true

must_haves:
  truths:
    - "Chart shows mean indicator (dot on curve)"
    - "Chart shows 90% interval as shaded region"
    - "Chart shows threshold as dashed vertical line with tooltip"
    - "Chart shows regret shading based on default decision"
    - "Hovering on chart shows lift % and dollar equivalent"
    - "Chart is integrated into the Uncertainty section"
  artifacts:
    - path: "src/components/charts/ChartTooltip.tsx"
      provides: "Custom tooltip with lift and dollar conversion"
      exports: ["ChartTooltip"]
    - path: "src/components/charts/PriorDistributionChart.tsx"
      provides: "Complete chart with all overlays"
      exports: ["PriorDistributionChart"]
  key_links:
    - from: "src/components/charts/PriorDistributionChart.tsx"
      to: "src/lib/calculations/chart-data.ts"
      via: "getDensityAtLift for mean marker"
      pattern: "getDensityAtLift"
    - from: "src/components/forms/UncertaintyPriorForm.tsx"
      to: "src/components/charts/PriorDistributionChart.tsx"
      via: "Renders chart with prior and calculation data"
      pattern: "PriorDistributionChart"
---

<objective>
Add chart overlays (mean marker, 90% interval, threshold line, regret shading, tooltip) and integrate the chart into the Uncertainty/Prior section.

Purpose: Complete the visualization requirements (VIZ-02 through VIZ-06) by adding all necessary overlays that help users understand their prior distribution relative to the threshold. Per 04-CONTEXT.md, the chart lives in the Prior section to visualize uncertainty input.

Output: Fully-featured distribution chart with interactive tooltip showing dollar equivalents, integrated into UncertaintyPriorForm.
</objective>

<execution_context>
@/Users/ryan.lucht/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryan.lucht/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-visualization-results/04-CONTEXT.md
@.planning/phases/04-visualization-results/04-RESEARCH.md
@.planning/phases/04-visualization-results/04-01-SUMMARY.md
@src/hooks/useEVPICalculations.ts
@src/lib/calculations/types.ts
@src/lib/formatting.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChartTooltip component with dollar conversion</name>
  <files>
    - src/components/charts/ChartTooltip.tsx
    - src/components/charts/index.ts
  </files>
  <action>
1. Create `src/components/charts/ChartTooltip.tsx`:
   ```typescript
   import { formatSmartCurrency } from '@/lib/formatting';

   interface ChartTooltipProps {
     active?: boolean;
     payload?: Array<{ payload: { liftPercent: number; density: number } }>;
     K: number; // Annual dollars per unit lift (for conversion)
   }

   export function ChartTooltip({ active, payload, K }: ChartTooltipProps) {
     if (!active || !payload?.length) return null;

     const { liftPercent } = payload[0].payload;
     const liftDecimal = liftPercent / 100;
     // Dollar impact = K * lift_L (K is dollars per unit lift)
     const dollarImpact = K * liftDecimal;

     return (
       <div className="bg-card border border-border rounded-lg px-3 py-2 shadow-lg">
         <p className="text-sm font-medium text-foreground">
           {liftPercent > 0 ? '+' : ''}{liftPercent.toFixed(1)}% lift
         </p>
         <p className="text-xs text-muted-foreground">
           â‰ˆ {formatSmartCurrency(dollarImpact)}/year
         </p>
       </div>
     );
   }
   ```

2. Update `src/components/charts/index.ts` to export ChartTooltip

Per VIZ-06: Dollar values as hover/callouts via K * L
  </action>
  <verify>
    - `npm run lint` passes
    - `npm run build` passes
  </verify>
  <done>
    - ChartTooltip displays lift percentage and dollar equivalent
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend PriorDistributionChart with all overlays</name>
  <files>
    - src/components/charts/PriorDistributionChart.tsx
    - src/lib/formatting.ts
  </files>
  <action>
1. Add formatting utility to `src/lib/formatting.ts`:
   ```typescript
   /**
    * Format probability as whole percentage for display
    *
    * Per 03-CONTEXT.md: Display whole percentages, show "<1%" or ">99%" for extremes
    */
   export function formatProbabilityPercent(decimal: number): string {
     const percent = decimal * 100;
     if (percent < 1) return '< 1%';
     if (percent > 99) return '> 99%';
     return `${Math.round(percent)}%`;
   }
   ```

2. Extend `PriorDistributionChart.tsx` props:
   ```typescript
   interface PriorDistributionChartProps {
     mu_L: number;           // Prior mean (decimal)
     sigma_L: number;        // Prior standard deviation (decimal)
     threshold_L: number;    // Threshold in lift units (decimal)
     K: number;              // Annual dollars per unit lift (for tooltip)
     defaultDecision: 'ship' | 'dont-ship'; // For regret shading direction
   }
   ```

3. Add overlays using Recharts components:

   **90% Interval Shading (VIZ-03):**
   - Calculate lowBound = mu_L - 1.6448536 * sigma_L (5th percentile)
   - Calculate highBound = mu_L + 1.6448536 * sigma_L (95th percentile)
   - Use ReferenceArea with x1={lowBound*100} x2={highBound*100}
   - Fill: #7C3AED (purple) with fillOpacity={0.15}
   - This should render BEFORE the curve Area

   **Regret Shading (VIZ-05):**
   - If defaultDecision === 'ship': shade from curve start to threshold (regret is below threshold)
   - If defaultDecision === 'dont-ship': shade from threshold to curve end (regret is above threshold)
   - Use ReferenceArea with fill="#EF4444" (red) fillOpacity={0.12}
   - Constrain to data bounds (first and last point liftPercent)
   - Per 04-CONTEXT.md: Claude's discretion on prominence - use subtle red

   **Threshold Line (VIZ-04):**
   - Use ReferenceLine with x={threshold_L * 100}
   - stroke="#6B7280" strokeDasharray="5 5" (dashed)
   - Add label with position="top":
     - For threshold > 0: "Ship if > +X%"
     - For threshold < 0: "Ship if > X%"
     - For threshold === 0: "Ship if positive"
   - fontSize: 11, fill: #6B7280

   **Mean Marker (VIZ-02):**
   - Use ReferenceDot at x={mu_L * 100}
   - y = getDensityAtLift(mu_L, mu_L, sigma_L) (density at mean = peak)
   - r={5} fill="#7C3AED" stroke="#FFFFFF" strokeWidth={2}

   **Custom Tooltip (VIZ-06):**
   - Add Tooltip component with content={<ChartTooltip K={K} />}

4. Order matters for layering:
   - defs (gradient)
   - ReferenceArea (90% interval) - background
   - ReferenceArea (regret shading) - background
   - ReferenceLine (threshold) - middle
   - Area (curve) - foreground
   - Tooltip
   - ReferenceDot (mean marker) - topmost
  </action>
  <verify>
    - `npm run lint` passes
    - `npm run build` passes
    - Visual: Chart shows all overlays correctly positioned
  </verify>
  <done>
    - Chart shows mean marker on curve
    - Chart shows 90% interval shading
    - Chart shows threshold as dashed line with label
    - Chart shows regret shading on correct side based on defaultDecision
    - Tooltip shows lift % and dollar equivalent on hover
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate chart into UncertaintyPriorForm</name>
  <files>
    - src/components/forms/UncertaintyPriorForm.tsx
  </files>
  <action>
1. Import the chart and hook:
   ```typescript
   import { PriorDistributionChart } from '@/components/charts';
   import { useEVPICalculations } from '@/hooks/useEVPICalculations';
   import { deriveK, normalizeThresholdToLift } from '@/lib/calculations';
   ```

2. In UncertaintyPriorForm component, get calculation results:
   ```typescript
   // Get EVPI results (returns null if inputs incomplete)
   const evpiResults = useEVPICalculations();
   ```

3. Add the chart below the interval inputs, conditionally rendered:
   - Only show chart when priorParams is valid (interval inputs are valid)
   - Pass props from evpiResults when available, otherwise derive from current interval

   For props derivation when evpiResults is null (user hasn't completed all steps):
   - mu_L and sigma_L: from computePriorFromInterval
   - threshold_L: default to 0 (any positive)
   - K: derive from baseline inputs if available, otherwise use 100000 as placeholder
   - defaultDecision: derive from mu_L vs threshold_L

4. Chart placement:
   - Below the "Implied expected lift" section
   - Inside a container with some top margin (mt-6)
   - Add a label: "Your belief distribution:"

5. Example conditional rendering:
   ```tsx
   {priorParams && (
     <div className="mt-6 space-y-2">
       <p className="text-sm font-medium text-foreground">
         Your belief distribution:
       </p>
       <PriorDistributionChart
         mu_L={priorParams.mu_L}
         sigma_L={priorParams.sigma_L}
         threshold_L={evpiResults?.threshold_L ?? 0}
         K={evpiResults?.K ?? derivedK ?? 100000}
         defaultDecision={
           priorParams.mu_L >= (evpiResults?.threshold_L ?? 0)
             ? 'ship'
             : 'dont-ship'
         }
       />
     </div>
   )}
   ```

Note: Per 04-CONTEXT.md, the chart lives in the Uncertainty section because it visualizes the prior. The threshold line updates when users change the threshold (if they've completed baseline), otherwise defaults to 0.
  </action>
  <verify>
    - `npm run lint` passes
    - `npm run build` passes
    - Manual: Navigate to Uncertainty section and see chart updating as interval changes
  </verify>
  <done>
    - Chart is integrated into UncertaintyPriorForm
    - Chart updates live as user changes interval bounds
    - Chart shows threshold when baseline inputs are complete
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run lint` - no lint errors
2. `npm test` - all existing tests still pass
3. `npm run build` - TypeScript compiles without errors
4. Manual testing:
   - Navigate to calculator, fill baseline section
   - In Uncertainty section, see chart appear with default prior
   - Change interval bounds, observe chart updates live
   - Hover over chart to see tooltip with lift and dollar values
   - Observe mean marker, 90% interval shading, threshold line
   - Change threshold scenario, observe regret shading changes
</verification>

<success_criteria>
- ChartTooltip shows lift % and dollar equivalent
- Chart displays mean marker (purple dot on curve)
- Chart displays 90% interval (purple shaded region)
- Chart displays threshold line (dashed with label)
- Chart displays regret shading (subtle red on appropriate side)
- Chart is integrated into UncertaintyPriorForm
- Chart updates reactively as inputs change
- Requirements VIZ-02, VIZ-03, VIZ-04, VIZ-05, VIZ-06 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-visualization-results/04-02-SUMMARY.md`
</output>
