---
phase: 02-basic-mode-inputs
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/validation.ts
  - src/lib/prior.ts
  - src/types/wizard.ts
  - src/components/forms/UncertaintyPriorForm.tsx
  - src/pages/CalculatorPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can select default prior N(0, 0.05) with one action"
    - "User can enter custom 90% interval bounds (L_low, L_high)"
    - "Custom interval inputs are always visible (not hidden behind toggle)"
    - "Implied mean is displayed and asymmetry is explained when mean != 0"
    - "Default interval values are pre-populated (~[-8.2%, +8.2%])"
  artifacts:
    - path: "src/lib/prior.ts"
      provides: "Prior parameter computation from interval"
      exports: ["computePriorFromInterval", "DEFAULT_PRIOR", "DEFAULT_INTERVAL"]
    - path: "src/lib/validation.ts"
      provides: "Zod schema for prior selection"
      exports: ["priorSelectionSchema"]
    - path: "src/components/forms/UncertaintyPriorForm.tsx"
      provides: "Uncertainty prior form component"
      exports: ["UncertaintyPriorForm"]
  key_links:
    - from: "src/components/forms/UncertaintyPriorForm.tsx"
      to: "wizardStore.setSharedInput"
      via: "stores priorType, intervalLow, intervalHigh"
      pattern: "setSharedInput.*priorType"
    - from: "src/components/forms/UncertaintyPriorForm.tsx"
      to: "src/lib/prior.ts"
      via: "computes mu_L and sigma_L from interval"
      pattern: "computePriorFromInterval"
---

<objective>
Implement the Uncertainty Prior form (Section 2) where users specify their belief about the effect size using either a default prior or custom 90% credible interval.

Purpose: Capture the user's uncertainty about potential lift, which drives the EVPI calculation. The prior represents "what we believe before running a test."

Output: Working uncertainty form with default/custom prior selection, interval inputs, mean display, and asymmetry explanation.
</objective>

<execution_context>
@/Users/ryan.lucht/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryan.lucht/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-basic-mode-inputs/02-CONTEXT.md
@.planning/phases/02-basic-mode-inputs/02-RESEARCH.md
@src/types/wizard.ts
@src/stores/wizardStore.ts
@src/lib/validation.ts
@src/components/forms/inputs/InfoTooltip.tsx
@SPEC.md (Section 6)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prior computation utilities and update types</name>
  <files>
    - src/lib/prior.ts
    - src/lib/validation.ts
    - src/types/wizard.ts
  </files>
  <action>
1. Create `src/lib/prior.ts`:

```typescript
/**
 * Prior Distribution Utilities
 *
 * Functions for computing Normal prior parameters from user inputs.
 * The prior represents uncertainty about relative lift L.
 *
 * Key formulas (from SPEC.md Section 6.2):
 *   mu_L = (L_low + L_high) / 2
 *   sigma_L = (L_high - L_low) / (2 * z_0.95)
 *
 * Where z_0.95 = 1.6448536 (95th percentile of standard normal)
 */

/**
 * z-score for 95th percentile of standard normal distribution
 * Used to convert 90% credible interval to standard deviation
 */
const Z_95 = 1.6448536;
const SIGMA_DIVISOR = 2 * Z_95; // 3.289707

export interface PriorParameters {
  /** Mean of prior distribution (decimal, e.g., 0.05 for 5% expected lift) */
  mu_L: number;
  /** Standard deviation of prior (decimal) */
  sigma_L: number;
}

/**
 * Compute Normal prior parameters from a 90% credible interval
 *
 * @param intervalLowPercent - Lower bound of 90% interval (percentage, e.g., -5 for -5%)
 * @param intervalHighPercent - Upper bound of 90% interval (percentage, e.g., 10 for 10%)
 * @returns Prior parameters { mu_L, sigma_L } as decimals
 *
 * Example: computePriorFromInterval(-8.22, 8.22) => { mu_L: 0, sigma_L: 0.05 }
 */
export function computePriorFromInterval(
  intervalLowPercent: number,
  intervalHighPercent: number
): PriorParameters {
  // Convert from percentage to decimal
  const L_low = intervalLowPercent / 100;
  const L_high = intervalHighPercent / 100;

  const mu_L = (L_low + L_high) / 2;
  const sigma_L = (L_high - L_low) / SIGMA_DIVISOR;

  return { mu_L, sigma_L };
}

/**
 * Default prior values per SPEC.md Section 6.2
 * Normal distribution centered at 0 with SD 0.05
 * Matches Eppo's documented default prior
 */
export const DEFAULT_PRIOR: PriorParameters = {
  mu_L: 0,
  sigma_L: 0.05,
};

/**
 * Default interval values that produce the default prior
 *
 * If sigma = 0.05, interval width = 0.05 * 3.289707 * 2 = 0.1645 * 2 = 0.3289
 * Wait, let me recalculate:
 *   sigma_L = (L_high - L_low) / 3.289707
 *   0.05 = (L_high - L_low) / 3.289707
 *   L_high - L_low = 0.05 * 3.289707 = 0.1645 (as decimal)
 *   In percentage: width = 16.45%
 *   Centered at 0: L_low = -8.22%, L_high = +8.22%
 */
export const DEFAULT_INTERVAL = {
  low: -8.22,   // percentage
  high: 8.22,   // percentage
};
```

2. Update `src/lib/validation.ts` - add prior selection schema:

```typescript
/**
 * Prior Selection Schema
 *
 * Users can either use the default prior or specify a custom 90% interval.
 * The interval bounds are in percentage form (e.g., -5% to 10%).
 *
 * Validation rules:
 * - Low bound can be negative (expecting loss)
 * - High bound can be >100% (expecting huge gains, though unusual)
 * - Low must be less than high
 * - Interval must not be impossibly narrow (results in sigma ~0)
 */
export const priorSelectionSchema = z.object({
  priorType: z.enum(['default', 'custom']),
  // Interval bounds in percentage form (-100 to theoretically unbounded)
  intervalLow: z
    .number({ required_error: 'Lower bound is required' })
    .min(-100, 'Cannot expect more than 100% loss'),
  intervalHigh: z
    .number({ required_error: 'Upper bound is required' }),
}).refine(
  (data) => data.intervalLow < data.intervalHigh,
  { message: 'Lower bound must be less than upper bound', path: ['intervalHigh'] }
).refine(
  (data) => (data.intervalHigh - data.intervalLow) >= 0.1,
  { message: 'Interval is too narrow (uncertainty too low)', path: ['intervalHigh'] }
);

export type PriorSelectionFormData = z.infer<typeof priorSelectionSchema>;
```

3. Update `src/types/wizard.ts` - add prior-related fields to SharedInputs:

```typescript
/** In SharedInputs interface, replace priorType and add interval fields: */

/** Prior type selection: 'default' uses N(0, 0.05), 'custom' uses interval bounds */
priorType: 'default' | 'custom' | null;
/** Lower bound of 90% credible interval (percentage form, e.g., -5 for -5%) */
priorIntervalLow: number | null;
/** Upper bound of 90% credible interval (percentage form, e.g., 10 for 10%) */
priorIntervalHigh: number | null;

/** In initialSharedInputs, add: */
priorType: null,
priorIntervalLow: null,
priorIntervalHigh: null,
```

Note: The old `priorType: string | null` should be updated to the union type.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Prior computation is accurate:
      ```
      computePriorFromInterval(-8.22, 8.22) => { mu_L: 0, sigma_L: ~0.05 }
      computePriorFromInterval(-5, 15) => { mu_L: 0.05, sigma_L: ~0.0608 }
      ```
  </verify>
  <done>Prior utilities created with correct formulas, types updated for prior fields</done>
</task>

<task type="auto">
  <name>Task 2: Build UncertaintyPriorForm component</name>
  <files>
    - src/components/forms/UncertaintyPriorForm.tsx
  </files>
  <action>
Create `src/components/forms/UncertaintyPriorForm.tsx`:

```typescript
/**
 * Uncertainty Prior Form
 *
 * Collects the user's prior belief about relative lift.
 * Two options:
 * 1. Default prior: N(0, 0.05) - "typical uncertainty"
 * 2. Custom 90% interval: user specifies L_low and L_high
 *
 * Per CONTEXT.md:
 * - Custom interval inputs always visible (not hidden)
 * - Default values pre-populated in interval fields
 * - "Use Default Prior" button resets to defaults
 * - Show implied mean when custom
 * - Explain asymmetric intervals (mean != 0)
 */
```

**Layout Structure:**

1. **Section intro text:**
   "How uncertain are you about whether this change will help or hurt?"

   InfoTooltip: "A 'prior' is your belief about the effect before running a test. A wider range means more uncertainty."

2. **Default Prior Option (prominent):**
   - Button/card: "Use Recommended Default"
   - Description: "I'm 90% sure the relative lift is between -8% and +8%"
   - Subtext: "This is a reasonable starting point if you're unsure. It assumes most changes have small effects."
   - When clicked: sets priorType to 'default' and resets interval fields to DEFAULT_INTERVAL

3. **Custom Interval Section (always visible):**
   - Label: "Or specify your own 90% credible interval:"
   - InfoTooltip: "This means you're 90% confident the true effect falls within this range."

   Two inputs side-by-side:
   - "I'm 90% sure the lift is at least" [_____]% (intervalLow)
   - "and at most" [_____]% (intervalHigh)

   Placeholders: "-5%" and "10%"

4. **Implied Mean Display (when custom and interval entered):**
   - Calculate: mean = (intervalLow + intervalHigh) / 2
   - Display: "Implied expected lift: X.X%"

5. **Asymmetry Explanation (when mean != 0):**
   Show when |mean| > 0.5 (percentage points):

   If mean > 0:
   - Mild (0.5-2%): "You're encoding a slight expectation that the change will help."
   - Moderate (2-5%): "You're encoding a moderate expectation of improvement."
   - Strong (>5%): "You're encoding a strong prediction that this change will win."

   If mean < 0:
   - Mild (-0.5 to -2%): "You're encoding a slight concern that this might hurt."
   - Moderate (-2 to -5%): "You're encoding some skepticism about this change."
   - Strong (<-5%): "You're encoding a strong expectation that this will underperform."

   Style: Info callout with subtle background (not alarming)

6. **Validation:**
   - Use react-hook-form with priorSelectionSchema
   - mode: 'onBlur'
   - Show errors below relevant inputs
   - Red border on invalid inputs

7. **State Management:**
   - When interval fields change AND are valid, auto-set priorType to 'custom'
   - When "Use Default" clicked, set priorType to 'default' and reset intervals
   - On form validation success (parent triggers), store:
     - priorType
     - priorIntervalLow
     - priorIntervalHigh

**Helper text per SPEC.md:**
"A normal curve is a solid, usually conservative first-pass model for effect sizes. Advanced mode can use other shapes."
  </action>
  <verify>
    - Component renders without errors
    - `npx tsc --noEmit` passes
    - `npm run lint` passes
  </verify>
  <done>UncertaintyPriorForm component with default/custom selection, interval inputs, and asymmetry messaging</done>
</task>

<task type="auto">
  <name>Task 3: Integrate UncertaintyPriorForm into CalculatorPage</name>
  <files>
    - src/pages/CalculatorPage.tsx
  </files>
  <action>
1. Import UncertaintyPriorForm in CalculatorPage

2. Replace placeholder content in uncertainty section (index 1) with UncertaintyPriorForm

3. Wire up validation:
   - Create form ref or validation callback pattern (matching baseline form)
   - When Next clicked on section 1 (uncertainty), trigger validation
   - If valid, store values and proceed to threshold section
   - If invalid, show errors

4. Ensure prior values persist:
   - Initialize form with values from wizardStore if present
   - On back navigation, form should show previously entered values

5. Test the flow:
   - Complete baseline section (from 02-01)
   - See uncertainty section become enabled
   - Interact with prior selection
   - Complete and advance to threshold
  </action>
  <verify>
    - `npm run lint` passes
    - `npm test` passes
    - `npm run build` succeeds
    - Manual: Complete baseline, uncertainty section enables
    - Manual: Click "Use Default", interval shows -8.22% to 8.22%
    - Manual: Enter custom interval, see implied mean
    - Manual: Enter asymmetric interval, see explanation
    - Manual: Next validates and advances to threshold
  </verify>
  <done>Uncertainty form integrated, default/custom selection works, asymmetry explained</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Lint passes: `npm run lint`
3. Tests pass: `npm test`
4. Build succeeds: `npm run build`
5. Manual verification:
   - Default prior button sets interval to [-8.22%, +8.22%]
   - Custom interval inputs accept negative values
   - Implied mean displays correctly
   - Asymmetric intervals show explanation
   - Validation prevents low >= high
   - Values persist on back navigation
   - Section completes and advances to threshold
</verification>

<success_criteria>
- User can select default prior N(0, 0.05) with "Use Recommended Default" button
- User can enter custom 90% interval bounds (L_low, L_high)
- Custom interval inputs are always visible (not hidden behind toggle)
- Implied mean is displayed: (L_low + L_high) / 2
- Asymmetry is explained when implied mean != 0
- Default interval values are pre-populated when using default
- Valid form data persists to Zustand store on section completion
- Invalid intervals show clear error messages
</success_criteria>

<output>
After completion, create `.planning/phases/02-basic-mode-inputs/02-02-SUMMARY.md`
</output>
