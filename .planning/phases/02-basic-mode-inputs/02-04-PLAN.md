---
phase: 02-basic-mode-inputs
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/forms/inputs/PercentageInput.tsx
  - src/components/forms/inputs/CurrencyInput.tsx
  - src/components/forms/inputs/NumberInput.tsx
  - src/components/forms/ThresholdScenarioForm.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can type '3.' and see '3.' in conversion rate field (decimal not stripped)"
    - "User can type '50.99' and see '50.99' in value per conversion field"
    - "User can type trailing decimals in any numeric input without character loss"
  artifacts:
    - path: "src/components/forms/inputs/PercentageInput.tsx"
      provides: "Local string state while focused, parse to number on blur only"
    - path: "src/components/forms/inputs/CurrencyInput.tsx"
      provides: "Local string state while focused, parse to number on blur only"
    - path: "src/components/forms/inputs/NumberInput.tsx"
      provides: "Local string state while focused, parse to number on blur only"
    - path: "src/components/forms/ThresholdScenarioForm.tsx"
      provides: "ThresholdInlineInput uses local string state while focused"
  key_links:
    - from: "Input onChange"
      to: "Local display state"
      via: "setDisplayValue(e.target.value)"
      pattern: "setDisplayValue\\(e\\.target\\.value\\)"
    - from: "Input onBlur"
      to: "field.onChange"
      via: "Parse and propagate to react-hook-form"
      pattern: "field\\.onChange\\(parsed\\)"
---

<objective>
Fix decimal input blocking in all numeric input components.

**Problem:** User cannot type decimal points (e.g., "3.2%", "$50.99") because onChange handlers immediately parse with parseFloat(), which converts "3." to 3, losing the trailing decimal.

**Solution:** Store raw input string in local state while focused, only parse to number on blur.

**Files:** PercentageInput.tsx, CurrencyInput.tsx, NumberInput.tsx, ThresholdScenarioForm.tsx (ThresholdInlineInput)

**UAT References:** Tests 1, 3
</objective>

<execution_context>
@/Users/ryan.lucht/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryan.lucht/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-basic-mode-inputs/02-UAT.md
@src/components/forms/inputs/PercentageInput.tsx
@src/components/forms/inputs/CurrencyInput.tsx
@src/components/forms/inputs/NumberInput.tsx
@src/components/forms/ThresholdScenarioForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PercentageInput decimal handling</name>
  <files>src/components/forms/inputs/PercentageInput.tsx</files>
  <action>
Refactor to use local string state for display while focused:

1. Add `displayValue` state alongside `isFocused`:
   ```typescript
   const [displayValue, setDisplayValue] = useState<string>('');
   ```

2. On focus: Initialize displayValue from field.value
   ```typescript
   const handleFocus = () => {
     setIsFocused(true);
     // Initialize display with current numeric value as string
     const val = field.value;
     setDisplayValue(val !== null && val !== undefined ? String(val) : '');
   };
   ```

3. On change: Update displayValue directly (raw string, no parsing)
   ```typescript
   const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
     setDisplayValue(e.target.value);
   };
   ```

4. On blur: Parse and propagate to react-hook-form
   ```typescript
   const handleBlur = () => {
     setIsFocused(false);
     const parsed = parsePercentage(displayValue);
     field.onChange(parsed);
     field.onBlur();
   };
   ```

5. Update Input value prop:
   - When focused: use displayValue (raw string)
   - When blurred: use formatDisplayValue(field.value) (formatted number)
   ```typescript
   value={isFocused ? displayValue : formatDisplayValue(field.value)}
   ```

This allows typing "3." without it being converted to "3" mid-keystroke.
  </action>
  <verify>
Run `npm test` to ensure existing tests pass.
Manual test: Type "3." in conversion rate field - decimal should remain visible.
  </verify>
  <done>User can type "3.2" character by character without losing the decimal point.</done>
</task>

<task type="auto">
  <name>Task 2: Fix CurrencyInput and NumberInput decimal handling</name>
  <files>src/components/forms/inputs/CurrencyInput.tsx, src/components/forms/inputs/NumberInput.tsx</files>
  <action>
Apply the same pattern from Task 1 to both files:

**CurrencyInput.tsx:**
1. Add `displayValue` state: `const [displayValue, setDisplayValue] = useState<string>('');`
2. handleFocus: Initialize displayValue from field.value
3. handleChange: `setDisplayValue(e.target.value)` (no parsing)
4. handleBlur: `const parsed = parseCurrency(displayValue); field.onChange(parsed); field.onBlur();`
5. Input value: `value={isFocused ? displayValue : formatDisplayValue(field.value)}`

**NumberInput.tsx:**
Same pattern but with parseNumber:
1. Add `displayValue` state
2. handleFocus: Initialize displayValue
3. handleChange: Update displayValue directly
4. handleBlur: `const parsed = parseNumber(displayValue); field.onChange(parsed); field.onBlur();`
5. Input value: `value={isFocused ? displayValue : formatDisplayValue(field.value)}`

Note: NumberInput has inputMode="numeric" (no decimal keyboard on mobile), but the underlying input should still accept decimal typing on desktop. If decimals are not expected for visitor counts, that's fine - the fix prevents any parsing bugs.
  </action>
  <verify>
Run `npm test` to ensure tests pass.
Manual test: Type "$50.99" in value per conversion - should display correctly.
  </verify>
  <done>CurrencyInput accepts decimal input (e.g., "$50.99"). NumberInput uses same robust pattern.</done>
</task>

<task type="auto">
  <name>Task 3: Fix ThresholdInlineInput decimal handling</name>
  <files>src/components/forms/ThresholdScenarioForm.tsx</files>
  <action>
The ThresholdInlineInput component (lines 98-193) has the same issue. Apply the same fix:

1. Add `displayValue` state inside the ThresholdInlineInput function:
   ```typescript
   const [displayValue, setDisplayValue] = useState<string>('');
   ```

2. Update handleFocus (currently line 148-150):
   ```typescript
   const handleFocus = () => {
     setIsFocused(true);
     const val = field.value;
     setDisplayValue(val !== null && val !== undefined ? String(val) : '');
   };
   ```

3. Update handleChange (currently lines 135-141):
   ```typescript
   const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
     setDisplayValue(e.target.value);
   };
   ```

4. Update handleBlur (currently lines 143-146):
   ```typescript
   const handleBlur = () => {
     setIsFocused(false);
     const parsed = unit === 'dollars'
       ? parseCurrency(displayValue)
       : parsePercentage(displayValue);
     field.onChange(parsed);
     field.onBlur();
   };
   ```

5. Update Input value prop (line 164):
   ```typescript
   value={isFocused ? displayValue : formatDisplayValue(field.value)}
   ```

This ensures threshold inputs (both $ and %) can accept decimal values.
  </action>
  <verify>
Run `npm test` to ensure tests pass.
Manual test: In "minimum lift" scenario, type "2.5%" or "$10,000.50" - decimals should persist.
  </verify>
  <done>ThresholdInlineInput accepts decimal input in both dollar and percentage modes.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. `npm test` passes
3. Manual UAT re-test:
   - Test 1: Type "3.2" in conversion rate - decimal persists, formats to "3.2%" on blur
   - Test 3: Type "50.99" in value per conversion - decimal persists, formats to "$50.99" on blur
   - Threshold inputs also accept decimals
</verification>

<success_criteria>
- All numeric inputs allow decimal point entry without stripping characters mid-typing
- Values are parsed and formatted correctly on blur
- Existing tests continue to pass
- UAT Tests 1 and 3 now pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-basic-mode-inputs/02-04-SUMMARY.md`
</output>
