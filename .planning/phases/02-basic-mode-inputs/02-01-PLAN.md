---
phase: 02-basic-mode-inputs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/types/wizard.ts
  - src/lib/validation.ts
  - src/lib/formatting.ts
  - src/components/ui/tooltip.tsx
  - src/components/forms/inputs/InfoTooltip.tsx
  - src/components/forms/inputs/PercentageInput.tsx
  - src/components/forms/inputs/CurrencyInput.tsx
  - src/components/forms/inputs/NumberInput.tsx
  - src/components/forms/BaselineMetricsForm.tsx
  - src/pages/CalculatorPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter baseline conversion rate as percentage with validation"
    - "User can enter annual visitors with editable unit label"
    - "User can enter value per conversion with dollar formatting"
    - "Validation errors appear on blur, not while typing"
    - "Continue button always enabled; clicking with invalid inputs shows errors"
  artifacts:
    - path: "src/lib/validation.ts"
      provides: "Zod schemas for baseline metrics"
      exports: ["baselineMetricsSchema"]
    - path: "src/lib/formatting.ts"
      provides: "Number formatting utilities"
      exports: ["formatCurrency", "formatPercentage", "parseCurrency", "parsePercentage"]
    - path: "src/components/forms/BaselineMetricsForm.tsx"
      provides: "Baseline metrics form with 3 inputs"
      exports: ["BaselineMetricsForm"]
  key_links:
    - from: "src/components/forms/BaselineMetricsForm.tsx"
      to: "wizardStore.setSharedInput"
      via: "form onSubmit stores validated values"
      pattern: "setSharedInput.*baselineConversionRate"
    - from: "src/pages/CalculatorPage.tsx"
      to: "src/components/forms/BaselineMetricsForm.tsx"
      via: "renders form in baseline section"
      pattern: "<BaselineMetricsForm"
---

<objective>
Install form validation dependencies and implement the Baseline Metrics form (Section 1) with conversion rate, annual visitors, and value per conversion inputs.

Purpose: Enable users to enter the three core business inputs that drive all subsequent calculations (K = N_year * CR0 * V).

Output: Working baseline metrics form with validation on blur, formatted inputs, and integration with wizard store.
</objective>

<execution_context>
@/Users/ryan.lucht/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryan.lucht/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-basic-mode-inputs/02-CONTEXT.md
@.planning/phases/02-basic-mode-inputs/02-RESEARCH.md
@src/types/wizard.ts
@src/stores/wizardStore.ts
@src/pages/CalculatorPage.tsx
@src/components/wizard/SectionWrapper.tsx
@SPEC.md (Sections 4, 5)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add tooltip component</name>
  <files>
    - package.json
    - src/components/ui/tooltip.tsx
    - src/components/forms/inputs/InfoTooltip.tsx
  </files>
  <action>
1. Install form validation dependencies:
   ```bash
   npm install react-hook-form zod @hookform/resolvers
   ```

2. Add shadcn tooltip component:
   ```bash
   npx shadcn@latest add tooltip
   ```
   This adds @radix-ui/react-tooltip and creates src/components/ui/tooltip.tsx

3. Create InfoTooltip wrapper component at `src/components/forms/inputs/InfoTooltip.tsx`:
   - Info icon (lucide-react Info, 16px)
   - Wraps Tooltip from shadcn/ui
   - Props: `content: React.ReactNode`
   - Trigger is a button with aria-label "More information"
   - Content appears on hover/focus with max-width 280px
   - Style: text-muted-foreground hover:text-foreground

Per CONTEXT.md: Info icon (i) with tooltip for unfamiliar terms. Tooltips appear on hover/click.
  </action>
  <verify>
    - `npm ls react-hook-form zod @hookform/resolvers` shows installed
    - `src/components/ui/tooltip.tsx` exists
    - `src/components/forms/inputs/InfoTooltip.tsx` exists
  </verify>
  <done>Form validation libraries installed, tooltip component available for use in forms</done>
</task>

<task type="auto">
  <name>Task 2: Create validation schemas and formatting utilities</name>
  <files>
    - src/lib/validation.ts
    - src/lib/formatting.ts
    - src/types/wizard.ts
  </files>
  <action>
1. Create `src/lib/validation.ts` with Zod schemas:

```typescript
/**
 * Validation Schemas
 *
 * Zod schemas for form validation. All numeric fields use z.number()
 * with appropriate constraints. Percentage inputs accept 0-100 in UI
 * but are stored as decimals (0-1) internally.
 */
import { z } from 'zod';

/**
 * Baseline Metrics Schema
 *
 * CR0: Baseline conversion rate
 * - UI: percentage (e.g., 3.2%)
 * - Validation: 0 < CR0 < 100
 * - Storage: decimal (0.032)
 *
 * N_year: Annual visitors/opportunities
 * - Validation: >= 1
 *
 * V: Value per conversion (dollars)
 * - Validation: >= 0.01
 */
export const baselineMetricsSchema = z.object({
  baselineConversionRate: z
    .number({ required_error: 'Conversion rate is required' })
    .gt(0, 'Must be greater than 0%')
    .lt(100, 'Must be less than 100%'),
  annualVisitors: z
    .number({ required_error: 'Annual visitors is required' })
    .int('Must be a whole number')
    .min(1, 'Must be at least 1'),
  visitorUnitLabel: z.string().min(1).default('visitors'),
  valuePerConversion: z
    .number({ required_error: 'Value per conversion is required' })
    .min(0.01, 'Must be at least $0.01'),
});

export type BaselineMetricsFormData = z.infer<typeof baselineMetricsSchema>;
```

2. Create `src/lib/formatting.ts`:

```typescript
/**
 * Input Formatting Utilities
 *
 * Uses native Intl.NumberFormat for locale-aware formatting.
 * Format on blur per CONTEXT.md decision.
 */

export function formatCurrency(value: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 2,
  }).format(value);
}

export function formatPercentage(value: number): string {
  // Input is percentage form (e.g., 5 for 5%)
  return `${value}%`;
}

export function formatNumber(value: number): string {
  return new Intl.NumberFormat('en-US').format(value);
}

export function parseCurrency(value: string): number | null {
  const cleaned = value.replace(/[^0-9.-]/g, '');
  const parsed = parseFloat(cleaned);
  return isNaN(parsed) ? null : parsed;
}

export function parsePercentage(value: string): number | null {
  const cleaned = value.replace(/[^0-9.-]/g, '');
  const parsed = parseFloat(cleaned);
  return isNaN(parsed) ? null : parsed;
}

export function parseNumber(value: string): number | null {
  const cleaned = value.replace(/[^0-9.-]/g, '');
  const parsed = parseFloat(cleaned);
  return isNaN(parsed) ? null : parsed;
}

/**
 * Convert percentage (5.0) to decimal (0.05)
 */
export function percentToDecimal(percent: number): number {
  return percent / 100;
}

/**
 * Convert decimal (0.05) to percentage (5.0)
 */
export function decimalToPercent(decimal: number): number {
  return decimal * 100;
}
```

3. Update `src/types/wizard.ts` to add `visitorUnitLabel` to SharedInputs:

Add to SharedInputs interface:
```typescript
/** User-editable label for visitors (visitors/sessions/leads/etc.) */
visitorUnitLabel: string;
```

Add to initialSharedInputs:
```typescript
visitorUnitLabel: 'visitors',
```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Files exist at specified paths
  </verify>
  <done>Validation schemas and formatting utilities ready for use in form components</done>
</task>

<task type="auto">
  <name>Task 3: Build BaselineMetricsForm and integrate into CalculatorPage</name>
  <files>
    - src/components/forms/inputs/PercentageInput.tsx
    - src/components/forms/inputs/CurrencyInput.tsx
    - src/components/forms/inputs/NumberInput.tsx
    - src/components/forms/BaselineMetricsForm.tsx
    - src/pages/CalculatorPage.tsx
  </files>
  <action>
1. Create `src/components/forms/inputs/PercentageInput.tsx`:
   - Controlled input with react-hook-form Controller
   - Shows raw number while editing, formatted with % on blur
   - Props: name, control, label, placeholder, error, helpText
   - Uses shadcn Input component
   - inputMode="decimal" for mobile numeric keyboard
   - Red border when error, error message below

2. Create `src/components/forms/inputs/CurrencyInput.tsx`:
   - Same pattern as PercentageInput
   - Shows raw number while editing, formatted with $ on blur
   - Handles dollar sign prefix display

3. Create `src/components/forms/inputs/NumberInput.tsx`:
   - For annual visitors
   - Additional prop: `unitLabel` that appears after the input
   - Unit label is editable (small text input next to main input)
   - inputMode="numeric" for whole numbers

4. Create `src/components/forms/BaselineMetricsForm.tsx`:

```typescript
/**
 * Baseline Metrics Form
 *
 * Collects the three core business inputs:
 * - Baseline conversion rate (CR0)
 * - Annual visitors (N_year)
 * - Value per conversion (V)
 *
 * These derive K = N_year * CR0 * V (annual dollars per unit lift)
 */
```

Structure:
- Use react-hook-form with zodResolver
- mode: 'onBlur' for validation timing
- Three input rows with labels and helper text:

  **Baseline Conversion Rate**
  - Label: "Baseline conversion rate"
  - Helper: "This is your current conversion rate for the metric and audience/targeting you'd be testing. Ideally, choose a metric that is a revenue-generating event (e.g., visitors → signups)."
  - Placeholder: "3.2%"
  - InfoTooltip: "The percentage of visitors who complete the desired action before any changes."

  **Annual Visitors**
  - Label: "Annual {unitLabel}" (e.g., "Annual visitors")
  - Helper: "Enter the number of {unitLabel} you expect in a year. If you only know monthly traffic, multiply by 12."
  - Placeholder: "1,000,000"
  - Editable unit label (small input to right or below)
  - InfoTooltip: "Your annualized traffic volume. This determines how much revenue impact a lift percentage translates to."

  **Value per Conversion**
  - Label: "Value per conversion"
  - Helper: "Put the business value of one conversion in dollars. Examples: average order value, gross margin per purchase, first-year LTV, or a blended estimate. Pick one that matches how you evaluate impact."
  - Placeholder: "$50"
  - InfoTooltip: "The dollar value your business gains from each conversion event."

- Form does NOT have a submit button (validation happens via parent's onValidate)
- Expose `validate()` method via ref or callback prop for parent to trigger
- On successful validation, call `setSharedInput` for each field:
  - `baselineConversionRate`: convert from percent to decimal before storing
  - `annualVisitors`: store as-is
  - `visitorUnitLabel`: store as-is
  - `valuePerConversion`: store as-is

5. Update `src/pages/CalculatorPage.tsx`:
   - Import BaselineMetricsForm
   - Replace placeholder content in baseline section with the form
   - Wire up validation: when Next is clicked, trigger form validation
   - If valid, mark section complete and proceed
   - If invalid, errors display on the form (don't advance)
   - Update handleNext to accept a validation callback from the form

Per CONTEXT.md: "Continue button always enabled — clicking with invalid inputs shows errors"
  </action>
  <verify>
    - `npm run lint` passes
    - `npm test` passes
    - `npm run build` succeeds
    - Manual: Navigate to calculator, baseline section shows 3 inputs with labels and help text
    - Manual: Enter invalid value, click Next, see error messages
    - Manual: Enter valid values, click Next, section completes
  </verify>
  <done>Baseline metrics form fully functional with validation, formatting, and store integration</done>
</task>

</tasks>

<verification>
1. All dependencies installed: `npm ls react-hook-form zod @hookform/resolvers`
2. TypeScript compiles: `npx tsc --noEmit`
3. Lint passes: `npm run lint`
4. Tests pass: `npm test`
5. Build succeeds: `npm run build`
6. Manual verification:
   - Conversion rate accepts percentages, shows % on blur
   - Annual visitors shows comma formatting, unit label editable
   - Value per conversion shows $ formatting
   - Empty required fields show errors on blur
   - Invalid values show specific error messages
   - Next button always enabled; clicking with errors shows them
   - Valid submission stores values and advances to next section
</verification>

<success_criteria>
- User can enter baseline conversion rate as percentage (0-100%) with validation
- User can enter annual visitors with editable unit label (visitors/sessions/leads)
- User can enter value per conversion with dollar formatting
- Validation errors appear on blur only (not while typing)
- Next button always enabled; clicking with invalid inputs shows errors
- Valid form data persists to Zustand store on section completion
- Values persist across mode switches and page navigation
</success_criteria>

<output>
After completion, create `.planning/phases/02-basic-mode-inputs/02-01-SUMMARY.md`
</output>
