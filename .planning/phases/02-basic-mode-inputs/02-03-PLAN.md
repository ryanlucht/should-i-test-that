---
phase: 02-basic-mode-inputs
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/validation.ts
  - src/types/wizard.ts
  - src/components/forms/inputs/RadioCard.tsx
  - src/components/forms/ThresholdScenarioForm.tsx
  - src/pages/CalculatorPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can select from 3 threshold scenarios via radio cards"
    - "Default scenario is pre-selected: 'Ship if any lift' (T=0)"
    - "Threshold input appears inline when scenario requires it"
    - "User can toggle between dollars and lift % for threshold value"
    - "Accept loss scenario stores negative threshold correctly"
  artifacts:
    - path: "src/components/forms/inputs/RadioCard.tsx"
      provides: "Styled radio card component"
      exports: ["RadioCard", "RadioCardGroup"]
    - path: "src/lib/validation.ts"
      provides: "Zod schema for threshold selection"
      exports: ["thresholdScenarioSchema"]
    - path: "src/components/forms/ThresholdScenarioForm.tsx"
      provides: "Threshold scenario form component"
      exports: ["ThresholdScenarioForm"]
  key_links:
    - from: "src/components/forms/ThresholdScenarioForm.tsx"
      to: "wizardStore.setSharedInput"
      via: "stores threshold scenario and value"
      pattern: "setSharedInput.*threshold"
    - from: "src/components/forms/ThresholdScenarioForm.tsx"
      to: "src/lib/formatting.ts"
      via: "formats threshold as currency or percentage"
      pattern: "formatCurrency|formatPercentage"
---

<objective>
Implement the Shipping Threshold form (Section 3) where users specify their decision threshold by selecting from three guided scenarios.

Purpose: Define what "worth shipping" means for this change. The threshold determines when the default decision switches between Ship and Don't Ship, and affects regret calculation.

Output: Working threshold form with three scenario radio cards, conditional inline inputs, and unit toggle ($ vs %).
</objective>

<execution_context>
@/Users/ryan.lucht/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryan.lucht/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-basic-mode-inputs/02-CONTEXT.md
@.planning/phases/02-basic-mode-inputs/02-RESEARCH.md
@src/types/wizard.ts
@src/stores/wizardStore.ts
@src/lib/validation.ts
@src/lib/formatting.ts
@src/components/forms/inputs/InfoTooltip.tsx
@src/components/ui/radio-group.tsx
@SPEC.md (Section 7)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RadioCard component and update types/validation</name>
  <files>
    - src/components/forms/inputs/RadioCard.tsx
    - src/lib/validation.ts
    - src/types/wizard.ts
  </files>
  <action>
1. Create `src/components/forms/inputs/RadioCard.tsx`:

```typescript
/**
 * Radio Card Component
 *
 * Styled card variant of RadioGroup using Radix primitives.
 * Cards have a selected state with purple border and light background.
 * Can contain inline content (inputs) that shows when selected.
 */

import * as RadioGroupPrimitive from '@radix-ui/react-radio-group';
import { cn } from '@/lib/utils';

interface RadioCardProps {
  value: string;
  title: string;
  description: string;
  children?: React.ReactNode; // Inline content when selected
  disabled?: boolean;
}

export function RadioCard({ value, title, description, children, disabled }: RadioCardProps) {
  return (
    <RadioGroupPrimitive.Item
      value={value}
      disabled={disabled}
      className={cn(
        // Base card styles
        'relative flex cursor-pointer flex-col rounded-xl border-2 p-4 text-left',
        'transition-all duration-200',
        // Default state
        'border-border bg-card hover:border-border/80 hover:shadow-sm',
        // Selected state (Radix data attribute)
        'data-[state=checked]:border-primary data-[state=checked]:bg-selected',
        // Focus state
        'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
        // Disabled state
        disabled && 'cursor-not-allowed opacity-50'
      )}
    >
      <div className="flex items-start gap-3">
        {/* Custom radio indicator */}
        <div className={cn(
          'mt-0.5 flex h-4 w-4 shrink-0 items-center justify-center rounded-full border-2',
          'border-muted-foreground',
          'data-[state=checked]:border-primary data-[state=checked]:bg-primary'
        )}>
          <RadioGroupPrimitive.Indicator>
            <div className="h-2 w-2 rounded-full bg-primary-foreground" />
          </RadioGroupPrimitive.Indicator>
        </div>
        <div className="flex-1 space-y-1">
          <p className="font-medium text-foreground">{title}</p>
          <p className="text-sm text-muted-foreground">{description}</p>
        </div>
      </div>
      {/* Inline content when selected - only visible when checked */}
      {children}
    </RadioGroupPrimitive.Item>
  );
}

interface RadioCardGroupProps {
  value: string;
  onValueChange: (value: string) => void;
  children: React.ReactNode;
  className?: string;
}

export function RadioCardGroup({ value, onValueChange, children, className }: RadioCardGroupProps) {
  return (
    <RadioGroupPrimitive.Root
      value={value}
      onValueChange={onValueChange}
      className={cn('space-y-3', className)}
    >
      {children}
    </RadioGroupPrimitive.Root>
  );
}
```

2. Update `src/lib/validation.ts` - add threshold scenario schema:

```typescript
/**
 * Threshold Scenario Schema
 *
 * Three scenarios per SPEC.md Section 7.3:
 * 1. Ship any positive impact (T = 0)
 * 2. Needs minimum lift (T > 0)
 * 3. Worth it even with small loss (T < 0)
 *
 * Note: For scenario 3, user enters "acceptable loss" as positive,
 * but we store as negative threshold internally.
 */
export const thresholdScenarioSchema = z.discriminatedUnion('scenario', [
  // Scenario 1: Ship any positive
  z.object({
    scenario: z.literal('any-positive'),
    // No threshold value needed - T = 0
  }),
  // Scenario 2: Minimum lift required
  z.object({
    scenario: z.literal('minimum-lift'),
    thresholdUnit: z.enum(['dollars', 'lift']),
    thresholdValue: z
      .number({ required_error: 'Threshold value is required' })
      .positive('Must be a positive value'),
  }),
  // Scenario 3: Accept small loss
  z.object({
    scenario: z.literal('accept-loss'),
    thresholdUnit: z.enum(['dollars', 'lift']),
    // User enters positive "acceptable loss"
    acceptableLoss: z
      .number({ required_error: 'Acceptable loss is required' })
      .positive('Enter as a positive value (e.g., 5 for 5% loss)'),
  }),
]);

export type ThresholdScenarioFormData = z.infer<typeof thresholdScenarioSchema>;
```

3. Update `src/types/wizard.ts` - update threshold fields in SharedInputs:

```typescript
/** In SharedInputs interface, replace/update threshold: */

/** Threshold scenario: 'any-positive' | 'minimum-lift' | 'accept-loss' */
thresholdScenario: 'any-positive' | 'minimum-lift' | 'accept-loss' | null;
/** Threshold unit when applicable: 'dollars' | 'lift' */
thresholdUnit: 'dollars' | 'lift' | null;
/** Threshold value in the selected unit (can be negative for accept-loss scenario) */
thresholdValue: number | null;

/** In initialSharedInputs, update/add: */
thresholdScenario: null,
thresholdUnit: null,
thresholdValue: null,
```

Remove the old `threshold: number | null` field if it exists.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - RadioCard component renders correctly
    - Schema validates all three scenario types
  </verify>
  <done>RadioCard component created, threshold schema and types defined</done>
</task>

<task type="auto">
  <name>Task 2: Build ThresholdScenarioForm component</name>
  <files>
    - src/components/forms/ThresholdScenarioForm.tsx
  </files>
  <action>
Create `src/components/forms/ThresholdScenarioForm.tsx`:

```typescript
/**
 * Threshold Scenario Form
 *
 * Collects the user's shipping threshold via guided scenarios.
 * Three options per SPEC.md Section 7.3:
 * 1. Ship any positive impact (T = 0)
 * 2. Needs minimum lift (T > 0)
 * 3. Worth it even with small loss (T < 0)
 *
 * Per CONTEXT.md:
 * - Horizontal radio cards for scenario selection
 * - Default pre-selected: "Ship if any lift"
 * - Inline input when scenario requires threshold value
 * - Toggle between $ and % for threshold unit
 */
```

**Layout Structure:**

1. **Section intro:**
   "What counts as 'worth shipping'?"

   InfoTooltip: "The threshold is the break-even point: below it, shipping is a mistake; above it, not shipping is a mistake."

   Subtext: "This helps determine whether the uncertainty about your change is costly."

2. **Scenario Radio Cards:**

**Scenario 1: Ship any positive (DEFAULT)**
- Title: "Ship if it helps at all"
- Description: "Any positive impact is worth shipping."
- No inline input needed
- When selected: thresholdValue = 0

**Scenario 2: Minimum lift required**
- Title: "Needs a minimum lift"
- Description: "Implementation cost, maintenance, or other trade-offs mean it needs at least some upside."
- Inline content (when selected):
  - Label: "Minimum required impact:"
  - Unit toggle: [$ per year] [% lift]
  - Input field with appropriate formatting
  - Placeholder: "$10,000" or "2%"

**Scenario 3: Accept small loss**
- Title: "Worth it even with a small loss"
- Description: "Strategic importance or long-term benefits justify shipping even if short-term metrics dip slightly."
- Inline content (when selected):
  - Label: "Maximum acceptable loss:"
  - Unit toggle: [$ per year] [% lift]
  - Input field (user enters positive number)
  - Placeholder: "$5,000" or "1%"
  - Helper: "Enter as a positive number (we'll treat it as a loss)"

3. **Unit Toggle Component:**
- Segmented button style (like mode toggle)
- Two options: "$ per year" | "% lift"
- Default: "$ per year"
- Switching units does NOT auto-convert values (clear the field)

4. **Inline Input Behavior:**
- Only show when parent card is selected
- Use CSS to show/hide smoothly (opacity + height transition)
- Input clears when switching scenarios

5. **Validation:**
- Use react-hook-form with thresholdScenarioSchema
- mode: 'onBlur'
- Scenarios 2 and 3 require positive numeric input when selected
- Show error below input if invalid

6. **State Management:**
When form validates successfully, store:
- thresholdScenario: 'any-positive' | 'minimum-lift' | 'accept-loss'
- thresholdUnit: 'dollars' | 'lift' (null for any-positive)
- thresholdValue:
  - Scenario 1: 0
  - Scenario 2: positive value as entered
  - Scenario 3: **negative** of the entered value (user enters 5, store -5)

**Sign Convention (CRITICAL per SPEC.md):**
Scenario 3 asks for "acceptable loss magnitude" but T_$ should be negative.
Comment this clearly in code:
```typescript
// Per SPEC.md Section 7.3: set T_$ = -Loss_$ for scenario 3
// User enters positive "5", we store as -5 (negative threshold)
```
  </action>
  <verify>
    - Component renders without errors
    - `npx tsc --noEmit` passes
    - `npm run lint` passes
    - Inline inputs appear/disappear correctly
    - Unit toggle switches between $ and %
  </verify>
  <done>ThresholdScenarioForm with three radio cards, conditional inline inputs, and unit toggle</done>
</task>

<task type="auto">
  <name>Task 3: Integrate ThresholdScenarioForm into CalculatorPage</name>
  <files>
    - src/pages/CalculatorPage.tsx
  </files>
  <action>
1. Import ThresholdScenarioForm in CalculatorPage

2. Replace placeholder content in threshold section (index 2) with ThresholdScenarioForm

3. Wire up validation:
   - Create form ref or validation callback pattern
   - When Next clicked on threshold section, trigger validation
   - If valid, store values and proceed to results section
   - If invalid, show errors

4. Default selection:
   - If no prior value in store, pre-select "any-positive" scenario
   - If user had previously selected a scenario, restore it

5. Ensure values persist:
   - Initialize form with values from wizardStore if present
   - On back navigation, form should show previously selected scenario and values

6. Handle the complete flow:
   - Complete baseline section
   - Complete uncertainty section
   - Complete threshold section
   - Advance to results (placeholder for now)

7. Update Results section placeholder text:
   - "Results will be calculated in Phase 3"
   - Show a summary of entered values for verification
  </action>
  <verify>
    - `npm run lint` passes
    - `npm test` passes
    - `npm run build` succeeds
    - Manual: Complete baseline and uncertainty, threshold section enables
    - Manual: Default scenario "Ship if any lift" is pre-selected
    - Manual: Select "Needs minimum lift", inline input appears
    - Manual: Toggle between $ and % units
    - Manual: Select "Accept small loss", enter value, verify stored as negative
    - Manual: Next validates and advances to results
    - Manual: Back navigation preserves selections
  </verify>
  <done>Threshold form integrated, all three scenarios work with inline inputs and unit toggle</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Lint passes: `npm run lint`
3. Tests pass: `npm test`
4. Build succeeds: `npm run build`
5. Manual verification:
   - Three radio cards display correctly
   - "Ship if any lift" is default selected
   - Selecting scenario 2 shows inline dollar/lift input
   - Selecting scenario 3 shows inline loss input
   - Unit toggle switches between $ and % formats
   - Validation prevents empty threshold when required
   - Scenario 3 stores negative threshold value
   - Values persist on back navigation
   - Full wizard flow: baseline -> uncertainty -> threshold -> results
</verification>

<success_criteria>
- User can select from 3 threshold scenarios via styled radio cards
- Default scenario "Ship if any lift" (T=0) is pre-selected
- Threshold input appears inline within selected card (scenarios 2 and 3)
- User can toggle between dollars/year and lift % for threshold value
- "Accept small loss" scenario stores threshold as negative value
- Valid form data persists to Zustand store on section completion
- Full wizard flow completes from baseline through to results placeholder
</success_criteria>

<output>
After completion, create `.planning/phases/02-basic-mode-inputs/02-03-SUMMARY.md`
</output>
