---
phase: 05-advanced-mode
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/forms/ExperimentDesignForm.tsx
  - src/lib/validation.ts
  - src/pages/CalculatorPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter test duration in days"
    - "User can enter or auto-derive daily traffic from annual visitors"
    - "User sees pre-filled defaults for split (50/50), eligibility (100%), latency (0)"
    - "Conversion latency field is visually de-emphasized"
    - "Form validates all experiment design inputs"
  artifacts:
    - path: "src/components/forms/ExperimentDesignForm.tsx"
      provides: "Experiment design input form"
      min_lines: 150
    - path: "src/lib/validation.ts"
      provides: "Zod schema for experiment design"
      contains: "experimentDesignSchema"
  key_links:
    - from: "src/components/forms/ExperimentDesignForm.tsx"
      to: "src/stores/wizardStore.ts"
      via: "setAdvancedInput"
      pattern: "setAdvancedInput.*testDurationDays"
    - from: "src/pages/CalculatorPage.tsx"
      to: "src/components/forms/ExperimentDesignForm.tsx"
      via: "import"
      pattern: "ExperimentDesignForm"
---

<objective>
Create the experiment design form for Advanced mode with duration, daily traffic, split, eligibility, and latency inputs.

Purpose: Collect test design parameters needed for EVSI and sample size calculation per ADV-IN-03 through ADV-IN-07.
Output: ExperimentDesignForm component integrated into calculator page for Advanced mode.
</objective>

<execution_context>
@/Users/ryan.lucht/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryan.lucht/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advanced-mode/05-CONTEXT.md
@.planning/phases/05-advanced-mode/05-RESEARCH.md
@src/components/forms/BaselineMetricsForm.tsx (pattern reference)
@src/components/forms/inputs/NumberInput.tsx
@src/components/forms/inputs/PercentageInput.tsx
@src/lib/validation.ts
@src/pages/CalculatorPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add experiment design validation schema</name>
  <files>src/lib/validation.ts</files>
  <action>
    Add Zod schema for experiment design form:

    ```typescript
    /**
     * Experiment design schema (Advanced mode)
     * Validates test parameters for EVSI calculation
     *
     * Per 05-CONTEXT.md defaults:
     * - trafficSplit: 0.5 (50/50 default)
     * - eligibilityFraction: 1.0 (100% default)
     * - conversionLatencyDays: 0 (default)
     * - decisionLatencyDays: 0 (default)
     * - testDurationDays: required (no default)
     * - dailyTraffic: required or auto-derived
     */
    export const experimentDesignSchema = z.object({
      // Required - user must enter
      testDurationDays: z.number({
        required_error: 'Test duration is required',
      }).positive('Duration must be positive').int('Duration must be whole days'),

      // Required - can be auto-derived from annual or manually entered
      dailyTraffic: z.number({
        required_error: 'Daily traffic is required',
      }).positive('Traffic must be positive'),

      // Pre-filled defaults
      trafficSplit: z.number()
        .min(0.1, 'Variant split must be at least 10%')
        .max(0.9, 'Variant split must be at most 90%')
        .default(0.5),

      eligibilityFraction: z.number()
        .min(0.01, 'Eligibility must be at least 1%')
        .max(1, 'Eligibility cannot exceed 100%')
        .default(1),

      // Optional with defaults (visually de-emphasized)
      conversionLatencyDays: z.number()
        .min(0, 'Latency cannot be negative')
        .int('Latency must be whole days')
        .default(0),

      decisionLatencyDays: z.number()
        .min(0, 'Latency cannot be negative')
        .int('Latency must be whole days')
        .default(0),
    });

    export type ExperimentDesignFormData = z.infer<typeof experimentDesignSchema>;
    ```
  </action>
  <verify>
    - `npm run typecheck` passes
    - Schema exports correctly
  </verify>
  <done>
    Experiment design validation schema added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ExperimentDesignForm component</name>
  <files>src/components/forms/ExperimentDesignForm.tsx</files>
  <action>
    Create ExperimentDesignForm.tsx following BaselineMetricsForm pattern:

    1. Component structure:
       - forwardRef with ExperimentDesignFormHandle (validate method)
       - Uses react-hook-form with zodResolver
       - Single card containing all experiment design fields

    2. Section intro:
       - Title: "Plan your experiment"
       - Description: "These parameters determine sample size and test precision"

    3. Input fields (in order):

       a) **Test Duration** (required, no default):
          - Label: "How long will you run the test?"
          - NumberInput with "days" suffix
          - Placeholder: "14"
          - Helper: "Enter duration in days. Longer tests = more data = less noise."

       b) **Daily Traffic** (required, can auto-derive):
          - Label: "Daily eligible traffic"
          - NumberInput (integer)
          - Below input: "Derive from annual" button that calculates N_year / 365
          - Helper: "Average daily visitors who can enter the experiment"
          - When auto-deriving, show computed value and allow override

       c) **Traffic Split** (pre-filled 50%):
          - Label: "Variant allocation"
          - PercentageInput
          - Default value: 50
          - Helper: "Percentage of traffic seeing the variant (50% = standard A/B)"

       d) **Eligibility Fraction** (pre-filled 100%):
          - Label: "Eligible traffic"
          - PercentageInput
          - Default value: 100
          - Helper: "What fraction of all traffic is eligible for this experiment?"

       e) **Conversion Latency** (visually de-emphasized, default 0):
          - Label: "Conversion latency"
          - NumberInput with "days" suffix
          - Default value: 0
          - Helper: "Days from exposure to expected conversion (e.g., 7 for weekly purchases)"
          - Style: Use text-muted-foreground for label, smaller font, or collapse by default
          - Per 05-CONTEXT.md: "visually de-emphasized (lower hierarchy than core fields)"

       f) **Decision Latency** (visually de-emphasized, default 0):
          - Label: "Decision latency"
          - NumberInput with "days" suffix
          - Default value: 0
          - Helper: "Days after test ends before you can ship the decision"
          - Same de-emphasized styling as conversion latency

    4. Store integration:
       - On blur/change, update store via setAdvancedInput for each field
       - Read initial values from store

    5. Auto-derive logic for daily traffic:
       - Read annualVisitors from shared inputs
       - Button: "Use annual/365" that sets dailyTraffic = Math.round(annualVisitors / 365)
       - Only show button if annualVisitors is set
  </action>
  <verify>
    - Component renders without errors
    - All fields validate correctly
    - Auto-derive button works
    - `npm run typecheck` passes
  </verify>
  <done>
    ExperimentDesignForm component created with all required inputs and validation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate ExperimentDesignForm into CalculatorPage</name>
  <files>src/pages/CalculatorPage.tsx</files>
  <action>
    Update CalculatorPage.tsx to include ExperimentDesignForm for Advanced mode:

    1. Import ExperimentDesignForm

    2. Add new section for experiment design (Advanced mode only):
       - Section ID: 'experiment-design'
       - Label in progress indicator: "Test Design"
       - Position: After Threshold section (index 3), before Results (now index 4 for Basic, 5 for Advanced)

    3. Conditional rendering:
       - Only show experiment design section when mode === 'advanced'
       - Adjust section indices based on mode

    4. Update section configuration:
       - Basic mode sections: Baseline (0), Uncertainty (1), Threshold (2), Results (3)
       - Advanced mode sections: Baseline (0), Uncertainty (1), Threshold (2), Test Design (3), Results (4)

    5. Update progress indicator labels array for Advanced mode:
       - Add "Test Design" label between "Threshold" and "Results"

    6. Wire up validation:
       - ExperimentDesignForm ref for validate() call
       - Include in section completion logic
  </action>
  <verify>
    - In Basic mode, 4 sections as before
    - In Advanced mode, 5 sections with "Test Design" added
    - Progress indicator shows correct labels per mode
    - Navigation works correctly in both modes
    - `npm test` passes
  </verify>
  <done>
    ExperimentDesignForm integrated into CalculatorPage, appearing only in Advanced mode.
  </done>
</task>

</tasks>

<verification>
Run validation:
```bash
npm run typecheck && npm test && npm run lint
```

Manual check:
1. Start dev server: `npm run dev`
2. In Basic mode, verify 4 sections (no Test Design)
3. Switch to Advanced mode
4. Verify 5 sections with "Test Design" after Threshold
5. Fill baseline metrics with annual visitors
6. Navigate to Test Design section
7. Verify auto-derive button computes daily traffic
8. Verify pre-filled defaults (50%, 100%, 0 days)
9. Verify latency fields are visually de-emphasized
</verification>

<success_criteria>
- Experiment design form renders in Advanced mode only
- All 6 input fields present with correct labels and helpers
- Pre-filled defaults: 50% split, 100% eligibility, 0 days latency
- Auto-derive daily traffic from annual works
- Conversion/decision latency visually de-emphasized
- Validation works for all fields
- Progress indicator shows correct section count per mode
</success_criteria>

<output>
After completion, create `.planning/phases/05-advanced-mode/05-03-SUMMARY.md`
</output>
