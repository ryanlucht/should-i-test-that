---
phase: 05-advanced-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.ts
  - src/vite-env.d.ts
  - src/types/wizard.ts
  - src/stores/wizardStore.ts
  - src/lib/calculations/distributions.ts
  - src/lib/calculations/distributions.test.ts
  - src/lib/calculations/index.ts
autonomous: true

must_haves:
  truths:
    - "jStat library is installed and available"
    - "Comlink and vite-plugin-comlink are installed"
    - "Distribution functions work for Normal, Student-t, and Uniform"
    - "Store can hold advanced prior shape and experiment design inputs"
  artifacts:
    - path: "src/lib/calculations/distributions.ts"
      provides: "PDF, CDF, sample functions for all prior shapes"
      exports: ["pdf", "cdf", "sample", "getPriorMean"]
    - path: "src/lib/calculations/distributions.test.ts"
      provides: "Unit tests for distribution functions"
      min_lines: 50
    - path: "src/types/wizard.ts"
      provides: "Extended AdvancedInputs with priorShape, studentTDf, experiment design fields"
  key_links:
    - from: "src/lib/calculations/distributions.ts"
      to: "jstat"
      via: "import"
      pattern: "import.*jStat.*from.*jstat"
    - from: "src/types/wizard.ts"
      to: "src/stores/wizardStore.ts"
      via: "type import"
      pattern: "AdvancedInputs"
---

<objective>
Install dependencies (jStat, Comlink), configure Vite for Web Workers, create distribution abstraction layer, and extend wizard types/store for Advanced mode inputs.

Purpose: Foundation for all Advanced mode calculations - distributions are needed by EVSI and chart; store updates enable UI forms.
Output: Working distribution module with tests, extended types/store, configured build system.
</objective>

<execution_context>
@/Users/ryan.lucht/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryan.lucht/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advanced-mode/05-CONTEXT.md
@.planning/phases/05-advanced-mode/05-RESEARCH.md
@src/types/wizard.ts
@src/stores/wizardStore.ts
@src/lib/calculations/statistics.ts
@src/lib/calculations/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure Vite</name>
  <files>package.json, vite.config.ts, src/vite-env.d.ts</files>
  <action>
    1. Install runtime dependencies:
       ```
       npm install jstat comlink
       ```
    2. Install dev dependency:
       ```
       npm install --save-dev vite-plugin-comlink
       ```
    3. Update vite.config.ts to add comlink plugin:
       - Import comlink from 'vite-plugin-comlink'
       - Add comlink() BEFORE react() in plugins array (order matters)
       - Add worker.plugins config: `worker: { plugins: () => [comlink()] }`
    4. Update src/vite-env.d.ts to add type reference:
       - Add: `/// <reference types="vite-plugin-comlink/client" />`
  </action>
  <verify>
    - `npm run build` completes without errors
    - vite.config.ts has comlink plugin configured
  </verify>
  <done>
    Dependencies installed, Vite configured for Comlink Web Workers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create distribution abstraction layer with tests</name>
  <files>src/lib/calculations/distributions.ts, src/lib/calculations/distributions.test.ts, src/lib/calculations/index.ts</files>
  <action>
    Create src/lib/calculations/distributions.ts with:

    1. Type definitions:
       - DistributionType = 'normal' | 'student-t' | 'uniform'
       - PriorDistribution interface with:
         - type: DistributionType
         - mu_L?: number (Normal/Student-t location)
         - sigma_L?: number (Normal/Student-t scale)
         - df?: number (Student-t degrees of freedom)
         - low_L?: number (Uniform lower bound)
         - high_L?: number (Uniform upper bound)

    2. pdf(lift_L, prior) function:
       - Normal: Use existing standardNormalPDF, transform z = (lift - mu) / sigma, scale by 1/sigma
       - Student-t: Use jStat.studentt.pdf(z, df) / sigma (CRITICAL: jStat uses standardized form)
       - Uniform: Return 1/(high - low) within bounds, 0 outside

    3. cdf(lift_L, prior) function:
       - Normal: Use existing standardNormalCDF with z-transform
       - Student-t: Use jStat.studentt.cdf(z, df)
       - Uniform: Linear interpolation (lift - low) / (high - low), clamped to [0, 1]

    4. sample(prior) function:
       - Normal: Box-Muller transform
       - Student-t: jStat.studentt.inv(Math.random(), df) * sigma + mu
       - Uniform: low + Math.random() * (high - low)

    5. getPriorMean(prior) helper:
       - Normal/Student-t: return mu_L
       - Uniform: return (low_L + high_L) / 2

    Add comprehensive comments explaining math (for statistician audit per CLAUDE.md).

    Create tests in distributions.test.ts:
    - Test pdf returns positive values in expected range
    - Test cdf is monotonic increasing
    - Test cdf(mu) ~ 0.5 for symmetric distributions
    - Test sample produces values in feasible range
    - Test getPriorMean returns correct values
    - Test Student-t with df=3, 5, 10
    - Test Uniform bounds

    Export from index.ts: pdf, cdf, sample, getPriorMean, PriorDistribution, DistributionType
  </action>
  <verify>
    - `npm test -- distributions` passes
    - All distribution functions exported from index
  </verify>
  <done>
    Distribution abstraction layer works for Normal, Student-t, and Uniform priors with passing tests.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend wizard types and store for Advanced mode</name>
  <files>src/types/wizard.ts, src/stores/wizardStore.ts</files>
  <action>
    Update src/types/wizard.ts:

    1. Update AdvancedInputs interface (replace existing fields):
       ```typescript
       export interface AdvancedInputs {
         // Prior shape (NEW per 05-CONTEXT.md)
         priorShape: 'normal' | 'student-t' | 'uniform' | null;
         studentTDf: 3 | 5 | 10 | null;  // Preset df values

         // Experiment design (UPDATED per 05-RESEARCH.md)
         testDurationDays: number | null;        // Duration in DAYS (not weeks)
         dailyTraffic: number | null;            // Daily eligible traffic (auto-derive from N_year/365 or manual)
         trafficSplit: number | null;            // Variant fraction 0-1 (default 0.5)
         eligibilityFraction: number | null;     // Fraction of traffic eligible (default 1)
         conversionLatencyDays: number | null;   // Days from exposure to conversion (default 0)
         decisionLatencyDays: number | null;     // Days after test to decide (default 0)
       }
       ```

    2. Update initialAdvancedInputs with new defaults:
       ```typescript
       export const initialAdvancedInputs: AdvancedInputs = {
         priorShape: null,           // Will default to 'normal' in UI
         studentTDf: null,
         testDurationDays: null,     // Required - user must enter
         dailyTraffic: null,         // Auto-derive or manual
         trafficSplit: 0.5,          // Default 50/50
         eligibilityFraction: 1,     // Default 100%
         conversionLatencyDays: 0,   // Default 0
         decisionLatencyDays: 0,     // Default 0
       };
       ```

    3. Remove old fields that are replaced (testDuration, dailyTestTraffic, trafficAllocation, testFixedCost, dailyCostOfDelay)

    The store (wizardStore.ts) should work automatically since it uses generic setAdvancedInput.
    Verify store tests still pass after type changes.
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm test -- wizardStore` passes
    - New fields are accessible via store selectors
  </verify>
  <done>
    Wizard types extended for Advanced mode with prior shape and experiment design inputs.
  </done>
</task>

</tasks>

<verification>
Run all validation:
```bash
npm run typecheck && npm test && npm run build
```
All checks must pass.
</verification>

<success_criteria>
- jStat, comlink, vite-plugin-comlink installed
- Vite configured for Web Workers with Comlink
- Distribution functions (pdf, cdf, sample) work for all 3 prior shapes
- Distribution tests pass
- Wizard types extended with new Advanced mode fields
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-advanced-mode/05-01-SUMMARY.md`
</output>
