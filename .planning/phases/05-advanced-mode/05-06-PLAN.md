---
phase: 05-advanced-mode
plan: 06
type: execute
wave: 3
depends_on: ["05-01", "05-05"]
files_modified:
  - src/components/results/AdvancedResultsSection.tsx
  - src/components/results/EVSIVerdictCard.tsx
  - src/components/results/CostOfDelayCard.tsx
  - src/components/results/index.ts
  - src/components/charts/PriorDistributionChart.tsx
  - src/lib/calculations/chart-data.ts
  - src/pages/CalculatorPage.tsx
autonomous: true

must_haves:
  truths:
    - "Advanced mode shows verdict: 'If you can test it for up to $[EVSI - CoD], test it'"
    - "EVSI, Cost of Delay, and Net Value are displayed separately"
    - "Cost of Delay card shows expandable breakdown (X days x $Y/day = $Z)"
    - "Chart reflects selected prior shape (Normal, Student-t, Uniform)"
    - "Loading state shows while EVSI calculates"
  artifacts:
    - path: "src/components/results/AdvancedResultsSection.tsx"
      provides: "Advanced mode results display"
      min_lines: 100
    - path: "src/components/results/EVSIVerdictCard.tsx"
      provides: "Advanced mode verdict card"
      min_lines: 40
    - path: "src/components/results/CostOfDelayCard.tsx"
      provides: "CoD card with expandable breakdown"
      min_lines: 50
  key_links:
    - from: "src/components/results/AdvancedResultsSection.tsx"
      to: "src/hooks/useEVSICalculations.ts"
      via: "import"
      pattern: "useEVSICalculations"
    - from: "src/components/charts/PriorDistributionChart.tsx"
      to: "src/lib/calculations/chart-data.ts"
      via: "generateDistributionData"
      pattern: "generateDistributionData"
---

<objective>
Create Advanced mode results UI with EVSI verdict, Cost of Delay card, and update chart to support all prior shapes.

Purpose: Display Advanced mode calculations with clear verdict per ADV-OUT-01 through ADV-OUT-07 and DESIGN-04.
Output: Complete Advanced mode results section with loading states and expandable CoD breakdown.
</objective>

<execution_context>
@/Users/ryan.lucht/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryan.lucht/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advanced-mode/05-CONTEXT.md
@.planning/phases/05-advanced-mode/05-RESEARCH.md
@.planning/phases/05-advanced-mode/05-05-SUMMARY.md (for useEVSICalculations interface)
@src/components/results/ResultsSection.tsx (pattern reference)
@src/components/results/VerdictCard.tsx (pattern reference)
@src/components/results/SupportingCard.tsx (pattern reference)
@src/components/charts/PriorDistributionChart.tsx
@src/lib/calculations/chart-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update chart-data.ts for all prior shapes</name>
  <files>src/lib/calculations/chart-data.ts</files>
  <action>
    Update generateDistributionData to support Normal, Student-t, and Uniform priors:

    1. Import pdf from distributions.ts

    2. Update function signature to accept PriorDistribution instead of mu_L/sigma_L:
       ```typescript
       export function generateDistributionData(
         prior: PriorDistribution,
         numPoints: number = 200
       ): { x: number; y: number }[]
       ```

    3. Determine x-axis range based on prior type:
       - Normal/Student-t: mu +/- 4*sigma (covers 99.99% of distribution)
       - Uniform: low to high (exact bounds)

    4. Generate y values using the pdf() function from distributions.ts

    5. For backward compatibility, keep existing function signature as overload or
       create a wrapper that builds Normal PriorDistribution from mu_L/sigma_L

    6. Update any existing callers (PriorDistributionChart) to pass PriorDistribution
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm test -- chart-data` passes
    - Chart data generates correctly for all 3 prior types
  </verify>
  <done>
    Chart data generation supports Normal, Student-t, and Uniform distributions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PriorDistributionChart for all prior shapes</name>
  <files>src/components/charts/PriorDistributionChart.tsx</files>
  <action>
    Update PriorDistributionChart to render all prior shapes:

    1. Accept prior shape from Advanced mode store:
       - Read priorShape and studentTDf from advancedInputs
       - Build PriorDistribution object based on shape

    2. Update data generation:
       - Call generateDistributionData with full PriorDistribution

    3. Handle Uniform distribution display:
       - Uniform PDF is a rectangle (constant value within bounds, 0 outside)
       - May need to add points at exact bounds for clean rendering

    4. Add visual indicator of distribution type (optional):
       - Could show shape name in chart legend or tooltip
       - Per 05-CONTEXT.md: "main chart updates live on selection"

    5. Ensure chart still works in Basic mode:
       - Basic mode always uses Normal (default shape)
       - Check mode and use Normal if mode === 'basic'
  </action>
  <verify>
    - Chart renders Normal distribution in Basic mode
    - Chart renders Student-t distribution when selected in Advanced mode
    - Chart renders Uniform distribution (rectangle) when selected
    - `npm run typecheck` passes
  </verify>
  <done>
    PriorDistributionChart renders all three distribution shapes correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Advanced mode results components</name>
  <files>src/components/results/EVSIVerdictCard.tsx, src/components/results/CostOfDelayCard.tsx, src/components/results/AdvancedResultsSection.tsx, src/components/results/index.ts</files>
  <action>
    Create EVSIVerdictCard.tsx:
    ```typescript
    /**
     * EVSI Verdict Card - Advanced mode primary verdict
     *
     * Per 05-CONTEXT.md verdict wording:
     * "If you can test it for **up to** $[EVSI - CoD], test it"
     *
     * Note: "up to" instead of Basic mode's "less than" to emphasize
     * EVSI as acceptable ceiling, not just maximum.
     */
    - Props: netValueDollars, isLoading, error
    - Display:
      - Loading state: Spinner with "Calculating..." text
      - Error state: Error message
      - Result: Bold verdict with formatted dollar amount
      - Note: "This is EVSI minus Cost of Delay â€” the realistic value of this specific test."
    - Style: Similar to VerdictCard but with purple accent (per DESIGN-04)
    ```

    Create CostOfDelayCard.tsx:
    ```typescript
    /**
     * Cost of Delay Card - Expandable breakdown
     *
     * Per 05-CONTEXT.md:
     * - Shown as derived value, with expandable breakdown on click
     * - Formula breakdown when expanded: "X days x $Y/day = $Z Cost of Delay"
     */
    - Props: codResults (from useEVSICalculations)
    - Display:
      - Header: "Cost of Delay" with formatted total
      - Collapsed: Just the total CoD value
      - Expanded (on click): Breakdown formula
        - "{testDurationDays} days x {dailyOpportunityCost}/day = {codDollars}"
        - If codApplies=false: "No Cost of Delay (default decision is not to ship)"
    - Use Collapsible from shadcn/ui or simple useState toggle
    - Style: Muted background, expandable with chevron icon
    ```

    Create AdvancedResultsSection.tsx:
    ```typescript
    /**
     * Advanced Results Section - Complete Advanced mode results display
     *
     * Requirements covered:
     * - ADV-OUT-01: Primary verdict "up to $Y"
     * - ADV-OUT-02: Y = max(0, EVSI - CoD)
     * - ADV-OUT-03: EVSI display (gross value)
     * - ADV-OUT-04: Cost of Delay display
     * - ADV-OUT-05: Net value display
     * - ADV-OUT-07: Probability test changes decision
     */
    - Uses useEVSICalculations hook
    - Layout:
      1. EVSIVerdictCard (primary, prominent)
      2. Supporting metrics grid (2x2):
         - EVSI (gross value): SupportingCard
         - Cost of Delay: CostOfDelayCard (expandable)
         - Net Value: SupportingCard
         - P(test changes decision): SupportingCard
      3. Prior/threshold cards (reuse from Basic mode)
    - Loading state: Skeleton or spinner while calculating
    - Error state: Error message with retry suggestion
    ```

    Update index.ts to export new components.
  </action>
  <verify>
    - Components render without errors
    - Verdict shows correct wording ("up to")
    - CoD card expands/collapses
    - `npm run typecheck` passes
  </verify>
  <done>
    Advanced mode results components created: EVSIVerdictCard, CostOfDelayCard, AdvancedResultsSection.
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate AdvancedResultsSection into CalculatorPage</name>
  <files>src/pages/CalculatorPage.tsx</files>
  <action>
    Update CalculatorPage.tsx to show AdvancedResultsSection in Advanced mode:

    1. Import AdvancedResultsSection

    2. In the Results section, conditionally render:
       ```tsx
       {mode === 'basic' ? (
         <ResultsSection />
       ) : (
         <AdvancedResultsSection />
       )}
       ```

    3. Ensure loading state is handled:
       - AdvancedResultsSection internally shows loading via useEVSICalculations
       - No extra loading handling needed in CalculatorPage

    4. Verify section enable/disable logic:
       - Results section should be accessible when all prior sections complete
       - Advanced mode has one extra section (Test Design), so Results is section 4
  </action>
  <verify>
    - Basic mode shows ResultsSection (unchanged)
    - Advanced mode shows AdvancedResultsSection
    - Loading state displays correctly
    - All existing functionality preserved
  </verify>
  <done>
    AdvancedResultsSection integrated into CalculatorPage for Advanced mode.
  </done>
</task>

</tasks>

<verification>
Run all tests:
```bash
npm run typecheck && npm test && npm run lint
```

Manual verification:
1. Start dev server: `npm run dev`
2. Basic mode: Verify results unchanged (EVPI verdict)
3. Switch to Advanced mode
4. Fill all inputs including Test Design
5. Verify:
   - Chart shows correct distribution shape
   - Loading state appears during calculation
   - Verdict shows "up to $X" format
   - EVSI, CoD, Net Value displayed
   - CoD card expands to show breakdown
   - P(test changes decision) displayed
</verification>

<success_criteria>
- Chart renders Normal, Student-t, and Uniform distributions correctly
- Advanced mode shows "up to $[EVSI - CoD]" verdict
- EVSI, CoD, and Net Value are clearly displayed
- CoD card has expandable breakdown
- Loading state shows during calculation
- Basic mode results unchanged
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-advanced-mode/05-06-SUMMARY.md`
</output>
