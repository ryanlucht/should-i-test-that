# Phase 6.1 Context: Calculation Bugs & Polish

## Source Requirements

From `phase 6.1.md` and `phase 6.1 cont.md` provided by user.

---

## High Priority (Correctness Bugs)

### 1. Monte Carlo EVSI ignores threshold in payoff calculation

**Problem:** In the Monte Carlo EVSI path, both the "value without test" and "value with test" are computed as `K * L_true` when shipping, which ignores the threshold `T_L`. This conflicts with the stated intent in the comments (and the EVPI/Normal EVSI formulas) where payoffs are relative to the threshold. This will systematically **overstate EVSI** when `T_L > 0` and **understate it** when `T_L < 0`.

**Fix:** Change `valueWithoutTest = K * L_true` to `valueWithoutTest = K * (L_true - threshold_L)` and same for `valueWithTest`.

**File:** `src/lib/calculations/evsi.ts`

### 2. Monte Carlo EVSI can divide by zero when all samples rejected

**Problem:** If the feasibility filter rejects all draws (e.g., very tight CR0 constraints + wide prior), `validSamples` can be 0. The code then divides by `validSamples`, yielding NaN EVSI and probabilities.

**Fix:** Add guard clause to return safe "no information" result when `validSamples === 0`.

**File:** `src/lib/calculations/evsi.ts`

---

## Resource/Cleanup Issues

### 3. Worker lifecycle cleanup incomplete

**Problem:** The EVSI worker is terminated only after successful completion. If an exception occurs before termination, or if the effect is invalidated during a running computation, the worker is left running.

**Fix:** Use `finally` block and track worker reference for cleanup in effect return.

**File:** `src/hooks/useEVSICalculations.ts`

### 4. Unused sectionRefs in CalculatorPage

**Problem:** `sectionRefs` is populated but never read. Dead state.

**Fix:** Remove the unused ref and ref assignments.

**File:** `src/pages/CalculatorPage.tsx`

---

## UX Polish

### 5. Advanced mode should have default prior option

Replicate the "Use Recommended Default" button from Basic mode in Advanced mode's Uncertainty section. Structure it to begin as a mirror of Basic mode, with shape selection and custom range as the "define your own" option.

**File:** `src/components/forms/PriorShapeForm.tsx`

### 6. Page footer updates

Footer should read: "Created by [Ryan Lucht](ryanlucht.com) and 100% vibe-coded by Claude Opus 4.5, GPT-5.2 Pro, GPT-Codex-5.2, and Gemini 3 Pro."

- Visible on both calculator pages AND intro page
- In Basic mode only, also show: "EVPI calculation based on 'How to Measure Anything' by Douglas Hubbard"

**Files:** Footer component, WelcomePage, CalculatorPage

### 7. Helper text and tooltip updates

In order of display:

1. Add helper text below "Baseline Metrics" section header: "This will help us calculate the range of potential outcomes from the test in dollars."
2. Remove tooltip for "Baseline conversion rate" (repetitive)
3. Remove tooltip for "Annual visitors" (repetitive)
4. Update "Annual visitors" helper text: "Enter the number of visitors you expect in a year, based on the audience and triggering conditions of the test."
5. Remove tooltip for "Value per conversion" (repetitive)
6. Reword "Uncertainty (Prior)" sub-head: "What do you think is a reasonable, but inclusive range of possible effect sizes from the idea you're testing?"
7. Change "A normal curve" to "A normal distribution" and remove ", usually conservative"
8. Add to default button helper text: "This is also the prior used in Eppo for Bayesian experiment analysis."
9. Remove sigma display in Basic mode; rename to "std dev" in Advanced mode
10. Remove tooltips for test design fields in Advanced mode: "How long will you run the test?", "Daily eligible traffic", "Variant allocation", "Eligible traffic"
11. Move "derive from annual" option inline with field title
12. Remove helper text below "Decision latency" (keep tooltip only)
13. Reword Advanced mode "how to interpret" box: "A/B tests infer the actual treatment effect of an idea based on sample information. In other words - they are imperfect information."

### 8. PNG export improvements

1. Remove date string from filename. Use:
   - Advanced: "Expected Value of Test - {name}.png"
   - Basic: "Expected Value of Perfect Information for {name}.png"
2. Baseline metrics already added (quick task 003b)
3. Show more detail on how final number is derived

---

## Suggested Plan Breakdown

1. **06.1-01**: Fix EVSI threshold bug + zero samples edge case (correctness)
2. **06.1-02**: Worker lifecycle cleanup + remove unused refs (cleanup)
3. **06.1-03**: Advanced mode default prior + footer updates (UX)
4. **06.1-04**: Helper text and tooltip updates (UX)
5. **06.1-05**: PNG export filename + detail improvements (UX)

---

*Created: 2026-02-02*
