---
phase: 06.1-calculation-bugs-polish
verified: 2026-02-02T19:22:00Z
status: gaps_found
score: 6/7 must-haves verified
gaps:
  - truth: "Helper text matches specification for all fields"
    status: failed
    reason: "Basic mode still says 'A normal curve' instead of 'A normal distribution'"
    artifacts:
      - path: "src/components/forms/UncertaintyPriorForm.tsx"
        issue: "Line 348 has 'A normal curve is a solid, usually conservative' - should be 'A normal distribution is a solid' without 'usually conservative'"
    missing:
      - "Change line 348 from 'A normal curve is a solid, usually conservative first-pass model' to 'A normal distribution is a solid first-pass model'"
---

# Phase 6.1: Calculation Bugs & Polish Verification Report

**Phase Goal:** Fix critical EVSI calculation bugs and improve UX polish across the application
**Verified:** 2026-02-02T19:22:00Z
**Status:** gaps_found
**Re-verification:** No — initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Monte Carlo EVSI correctly uses threshold in payoff calculation (K * (L_true - T_L)) | ✓ VERIFIED | Lines 140-148 and 178-184 in evsi.ts use threshold-relative formula |
| 2 | Zero valid samples edge case returns safe "no information" result (EVSI=0) | ✓ VERIFIED | Lines 195-204 in evsi.ts guard clause returns safe defaults |
| 3 | Worker lifecycle properly cleaned up on unmount and errors | ✓ VERIFIED | Lines 333-339 (finally block) and 345-351 (cleanup) in useEVSICalculations.ts |
| 4 | Advanced mode has default prior option matching Basic mode | ✓ VERIFIED | Lines 259-290 in PriorShapeForm.tsx with Eppo attribution at line 286 |
| 5 | Footer displays credits and attribution on all pages | ✓ VERIFIED | WelcomePage.tsx lines 65-83, CalculatorPage.tsx lines 366-386 with mode-aware Hubbard text |
| 6 | Helper text and tooltips updated per specification | ✗ FAILED | Most updates done, but "A normal curve" → "A normal distribution" change missed |
| 7 | PNG export filenames are descriptive (no timestamps) | ✓ VERIFIED | useExportPng.ts lines 59-69 generates descriptive filenames without timestamps |

**Score:** 6/7 truths verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/lib/calculations/evsi.ts` | Threshold-relative payoff calculation | ✓ VERIFIED | Lines 144, 180: `K * (L_true - threshold_L)` |
| `src/lib/calculations/evsi.ts` | Zero valid samples guard | ✓ VERIFIED | Lines 195-204: returns EVSI=0 when validSamples===0 |
| `src/lib/calculations/evsi.test.ts` | Test coverage for fixes | ✓ VERIFIED | Lines 377-418 (threshold test), lines 425-448 (zero samples test) |
| `src/hooks/useEVSICalculations.ts` | Worker cleanup in finally and effect | ✓ VERIFIED | Lines 333-339 (finally), 345-351 (cleanup function) |
| `src/components/forms/PriorShapeForm.tsx` | Default prior button | ✓ VERIFIED | Lines 259-290 with Eppo text at line 286 |
| `src/components/forms/UncertaintyPriorForm.tsx` | Sigma display logic | ✓ VERIFIED | Lines 588-593: hidden in Basic, shows "std dev" in Advanced |
| `src/pages/WelcomePage.tsx` | Footer with credits | ✓ VERIFIED | Lines 65-83: creator, AI credits, Hubbard reference |
| `src/pages/CalculatorPage.tsx` | Mode-aware footer | ✓ VERIFIED | Lines 366-386: mode check at line 379 for Hubbard text |
| `src/hooks/useExportPng.ts` | Descriptive filenames | ✓ VERIFIED | Lines 59-69: mode-based patterns without timestamps |
| `src/components/forms/BaselineMetricsForm.tsx` | Section helper text | ✓ VERIFIED | Lines 152-155: "This will help us calculate..." |
| `src/components/forms/BaselineMetricsForm.tsx` | No tooltips on fields | ✓ VERIFIED | Lines 158-184: no tooltip props on inputs |
| `src/components/forms/ExperimentDesignForm.tsx` | Tooltips removed except latency | ✓ VERIFIED | Only Decision latency has tooltip (line 243) |
| `src/components/results/AdvancedResultsSection.tsx` | Imperfect information text | ✓ VERIFIED | Line 206: "imperfect information" wording |
| `src/components/forms/UncertaintyPriorForm.tsx` | Normal distribution text | ✗ STUB | Line 348: still says "A normal curve...usually conservative" |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|----|--------|---------|
| evsi.ts:144 | Threshold-relative payoff | `K * (L_true - threshold_L)` | ✓ WIRED | Ship decision uses threshold subtraction |
| evsi.ts:180 | Threshold-relative payoff | `K * (L_true - threshold_L)` | ✓ WIRED | Test-based ship decision uses threshold subtraction |
| evsi.ts:195 | Zero samples guard | `if (validSamples === 0)` | ✓ WIRED | Returns before division by zero |
| useEVSICalculations.ts:333 | Worker termination | finally block | ✓ WIRED | Terminates worker on success or error |
| useEVSICalculations.ts:345 | Cleanup on unmount | effect return function | ✓ WIRED | Terminates worker if still running |
| PriorShapeForm.tsx:286 | Eppo attribution | helper text | ✓ WIRED | Text appears below default button |
| useExportPng.ts:64-68 | Filename generation | mode param | ✓ WIRED | Different patterns for basic vs advanced |

### Requirements Coverage

All requirements from CONTEXT.md addressed:

| Requirement | Status | Supporting Truth |
|-------------|--------|-----------------|
| Fix EVSI threshold bug | ✓ SATISFIED | Truth #1 verified |
| Fix zero samples edge case | ✓ SATISFIED | Truth #2 verified |
| Fix Worker lifecycle cleanup | ✓ SATISFIED | Truth #3 verified |
| Advanced mode default prior | ✓ SATISFIED | Truth #4 verified |
| Footer credits/attribution | ✓ SATISFIED | Truth #5 verified |
| Helper text updates | ✗ BLOCKED | Truth #6 failed (1 item incomplete) |
| PNG export filenames | ✓ SATISFIED | Truth #7 verified |

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| src/components/forms/UncertaintyPriorForm.tsx | 348 | Outdated text | ⚠️ Warning | Minor UX inconsistency - text says "curve" not "distribution" |

### Gaps Summary

**6 of 7 success criteria verified.** One minor gap remains:

The helper text update specification (item #7 in CONTEXT.md) required changing "A normal curve" to "A normal distribution" and removing ", usually conservative". This change was specified in the context but was not included in any of the 5 plan files and therefore was not implemented.

**Impact:** Low. This is purely a text inconsistency. The text at line 348 of UncertaintyPriorForm.tsx should be updated from:
```
'A normal curve is a solid, usually conservative first-pass model for effect sizes. Advanced mode can use other shapes.'
```

to:
```
'A normal distribution is a solid first-pass model for effect sizes. Advanced mode can use other shapes.'
```

All critical calculation bugs are fixed, worker lifecycle is properly managed, and nearly all UX polish items are complete.

---

_Verified: 2026-02-02T19:22:00Z_
_Verifier: Claude (gsd-verifier)_
