---
phase: 06.1-calculation-bugs-polish
plan: 01
subsystem: calculations
tags: [evsi, monte-carlo, threshold, edge-cases]

# Dependency graph
requires:
  - phase: 05
    provides: Monte Carlo EVSI implementation
provides:
  - Fixed threshold-relative payoff calculation in EVSI
  - Zero valid samples edge case handling
  - Test coverage for both fixes
affects: [results display, advanced mode calculations]

# Tech tracking
tech-stack:
  added: []
  patterns: [threshold-relative value calculation, defensive edge case handling]

key-files:
  created: []
  modified:
    - src/lib/calculations/evsi.ts
    - src/lib/calculations/evsi.test.ts

key-decisions:
  - "Payoff uses K * (L_true - threshold_L) not K * L_true - aligns with EVPI formula"
  - "Zero valid samples returns EVSI=0 with probabilityTestChangesDecision=0"

patterns-established:
  - "Threshold-relative: All value calculations measure relative to threshold baseline"
  - "Safe edge cases: Return sensible defaults instead of NaN/Infinity"

# Metrics
duration: 4min
completed: 2026-02-02
---

# Phase 6.1 Plan 01: EVSI Calculation Bug Fixes Summary

**Fixed Monte Carlo EVSI to use threshold-relative payoffs and handle zero valid samples safely**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-02T19:16:30Z
- **Completed:** 2026-02-02T19:20:30Z
- **Tasks:** 3
- **Files modified:** 2

## Accomplishments
- Fixed critical EVSI calculation bug: payoffs now use K * (L_true - threshold_L) instead of absolute K * L_true
- Added guard for zero valid samples edge case to prevent NaN from division by zero
- Added test coverage for threshold-relative payoff behavior and zero samples edge case

## Task Commits

All tasks committed together as a single atomic fix:

1. **Task 1: Fix Monte Carlo EVSI threshold payoff calculation** - `43d7b02` (fix)
2. **Task 2: Fix zero valid samples edge case** - `43d7b02` (fix)
3. **Task 3: Add test coverage for fixes** - `43d7b02` (test)

## Files Created/Modified
- `src/lib/calculations/evsi.ts` - Fixed payoff calculation and added zero samples guard
- `src/lib/calculations/evsi.test.ts` - Added tests for threshold-relative payoff and zero samples

## Decisions Made
- **Threshold-relative payoff:** Changed from `K * L_true` to `K * (L_true - threshold_L)` for shipping decisions. This aligns with the EVPI formula approach where value is measured relative to the threshold baseline.
- **Zero samples return safe defaults:** When all Monte Carlo samples are rejected by the feasibility filter, return EVSI=0 with `probabilityTestChangesDecision=0` rather than producing NaN.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Initial threshold-relative payoff test compared against a zero-threshold result that produced EVSI=0, causing the test to fail. Rewrote test to compare different threshold scenarios without division issues.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- EVSI calculation now correctly handles threshold-relative payoffs
- Zero valid samples edge case safely handled
- Ready for Worker lifecycle cleanup (Plan 02)

---
*Phase: 06.1-calculation-bugs-polish*
*Completed: 2026-02-02*
